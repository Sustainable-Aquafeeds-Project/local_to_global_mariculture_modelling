---
title: "Formulating experimental feeds"
author: Tormey Reimer
date: today
editor: source
---

# Introduction

The purpose of this markdown is to formulate all the feeds that will be used in the analysis.

```{r setup, include=F, cache=F}
#| code-summary: R setup

library(tidyverse)
library(arrow)
library(sf)
library(terra)
library(furrr)
library(future)
library(tictoc)
library(fs)
library(conflicted)
library(readxl)
library(units)
library(qs)
library(here)
conflicts_prefer(dplyr::filter(), dplyr::select(), .quiet = T)

here("src") %>% 
  list.files(pattern = "\\.R$", full.names = TRUE) %>% 
  walk(source)
```

# Import ingredients

There is no check or correction here to ensure that protein + lipid + ash + carb = 1 in the incoming ingredient data. This was checked manually prior to import. 

``` {r import-ingredients}
#| code-summary: Get ingredient details (PLC composition, digestibility)

ingreds <- file.path(bigdata_path, "all_ingredients.xlsx") %>% 
  read_excel(sheet = "all_ingredients") %>% 
  mutate(ingredient = as.factor(ingredient))

ingred_nms <- levels(ingreds$ingredient)
```

# Import feeds

Unlike ingredients, the feeds do not need to be checked for sum = 1 prior to import. That check is done here.

``` {r import-feeds}
#| code-summary: Feed compositions

feed_inputs <- file.path(input_feed_profile_path, "all_feeds.xlsx") %>% 
  read_excel(sheet = "all_feeds")
  
feed_inputs <- feed_inputs %>% 
  pivot_longer(names_to = "feed", values_to = "proportion", cols = !contains(c("ingredient", "category"))) %>% 
  mutate(
    feed = as.factor(feed),
    ingredient = as.factor(ingredient),
    proportion = case_when(is.na(proportion) ~ 0, T ~ proportion)
  ) %>% 
  left_join(ingreds, by = "ingredient")
```

Include the range of digestibility values so that feeds can be sampled (if required) within the targets pipeline.

```{r min-max-values}
#| code-summary: Novel feeds use the mean digestibility values

feed_inputs <- feed_inputs %>% 
  rename(
    protein_digestibility = mean_protein_digestibility,
    carb_digestibility = mean_carb_digestibility,
    lipid_digestibility = mean_lipid_digestibility
  )

feed_types <- levels(feed_inputs$feed)
```

Check that ingredient proportions sum to 1.

```{r check-proportions}
#| code-summary: Composition proportions

feed_inputs <- feed_inputs %>% 
  filter(!is.na(proportion) & proportion != 0) %>% 
  group_by(feed) %>% 
  mutate(
    sum = sum(proportion),
    proportion = proportion/sum
  ) %>% 
  ungroup() %>% 
  select(-sum, -ash)
```

# Prepare for pipeline

The following chunk allows as many ingredients and feeds to be added to the incoming data as needed, it will still be formatted into a form that the `targets` pipelines can use. This code does not create the "min" and "max" deigestibility versions of the feeds, they are created in the targets pipeline. 

```{r formulate-feeds}
#| code-summary: Format feeds as lists to feed into targets

feed_types <- levels(feed_inputs$feed)

feed_params <- purrr::map(feed_types, function(ft) {
  # Filter by specified feed
  df <- feed_inputs %>% filter(feed == ft) 

  list(
    Proteins = df %>% 
      select(ingredient, proportion, contains("protein")) %>% 
      rename(
        macro = protein, 
        digest = protein_digestibility,
        min_digest = min_protein_digestibility,
        max_digest = max_protein_digestibility
      ),
    Carbohydrates = df %>% 
      select(ingredient, proportion, contains("carb")) %>% 
      rename(
        macro = carb, 
        digest = carb_digestibility,
        min_digest = min_carb_digestibility,
        max_digest = max_carb_digestibility
      ),
    Lipids = df %>% 
      select(ingredient, proportion, contains("lipid")) %>% 
      rename(
        macro = lipid, 
        digest = lipid_digestibility,
        min_digest = min_lipid_digestibility,
        max_digest = max_lipid_digestibility
      )
  )
}) %>% 
  setNames(feed_types)
```

```{r save}
#| code-summary: Save feed params file

qsave(feed_params, file.path(output_species_data_path, "feed_params.qs"))
```

# Comparing feeds

The three "biomar" feeds were designed to be isoenergetic.

```{r feed-stats}
#| code-summary: Calculate some stats about the feeds

feed_stats <- feed_inputs %>% 
  select(-contains(c("max", "min"))) %>% 
  mutate(
    ing_protein = proportion * protein,
    ing_carb = proportion * carb,
    ing_lipid = proportion * lipid,
    digest_protein = ing_protein * protein_digestibility,
    digest_carb = ing_carb * carb_digestibility,
    digest_lipid = ing_lipid * lipid_digestibility,
    E_protein = digest_protein * 17,
    E_carb = digest_carb * 16.8,
    E_lipid = digest_lipid * 37.6
  ) %>% 
  group_by(feed) %>% 
  reframe(
    total_protein = sum(ing_protein),
    total_carb = sum(ing_carb),
    total_lipid = sum(ing_lipid),
    AD_protein = sum(digest_protein),
    AD_carb = sum(digest_carb),
    AD_lipid = sum(digest_lipid),
    E_protein = sum(E_protein),
    E_carb = sum(E_carb),
    E_lipid = sum(E_lipid)
    ) %>% 
  mutate(
    E = E_protein + E_carb + E_lipid,
    group = case_when(str_detect(feed, "biomar") ~ "biomar", T ~ "other")
  ) %>% 
  relocate(group, .before = "feed") %>% 
  arrange(group)

feed_stats %>% 
  select(group, feed, E)
```

```{r feed-macro-digestibility}
#| code-summary: Code to generate plot
#| fig-cap: Total protein, carbohydrate and lipid composition of each feed, with the undigestible portion shown as the lighter bars on top. 

merge(
  feed_stats %>% 
    select(feed, group, contains("total_")) %>% 
    pivot_longer(
      cols = contains("total"),
      names_to = "macro", names_prefix = "total_",
      values_to = "total"
    ),
  feed_stats %>% 
    select(feed, group, contains("AD_")) %>% 
    pivot_longer(
      cols = contains("AD"),
      names_to = "macro", names_prefix = "AD_",
      values_to = "AD"
    ),
  by = c("feed", "group", "macro")
  ) %>% 
  mutate(feed = as.factor(feed)) %>%   
  ggplot(aes(x = macro, fill = feed)) +
  geom_col(aes(y = total), position = position_dodge(), alpha = 0.5, colour = "black") +
  geom_col(aes(y = AD), position = position_dodge(), alpha = 0.75, colour = "black") +
  theme_classic() +
  facet_wrap(facets = vars(group))
```

```{r feed-energy}
#| code-summary: Code to generate plot
#| fig-cap: The proportion of energy derived from protein, carbohydrate and lipid within each feed.

feed_stats %>% 
  mutate(
    E_protein = E_protein/E,
    E_carb = E_carb/E,
    E_lipid = E_lipid/E
  ) %>% 
  select(feed, group, contains("E_")) %>% 
  pivot_longer(
    cols = contains("E_"),
    names_to = "macro", names_prefix = "E_",
    values_to = "value"
  ) %>% 
  ggplot(aes(x = macro, y = value, fill = feed)) +
  geom_col(position = position_dodge(), colour = "black") +
  theme_classic() +
  facet_wrap(facets = vars(group))
```
