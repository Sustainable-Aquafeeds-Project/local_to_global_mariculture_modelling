---
title: "Process data from Atlantic salmon model runs"
author: "Tormey Reimer"
date: today
---

# Introduction

This script takes outputs from the targets pipeline.

```{r setup}
#| warning: false
#| message: false

library(tidyverse)
library(arrow)
library(sf)
library(terra)
library(magrittr)
library(furrr)
library(future)
library(tictoc)
library(fs)
library(conflicted)
library(readxl)
library(units)
library(qs)
library(here)
library(targets)
conflicted::conflicts_prefer(dplyr::filter(), dplyr::select(), .quiet = T)

here("src") %>% 
  list.files(pattern = "\\.R$", full.names = TRUE) %>% 
  walk(source)

remove_unit("g_fish")
remove_unit("kg_fish")
remove_unit("t_fish")
install_unit("g_fish")
install_unit("kg_fish", "1000 g_fish")
install_unit("t_fish", "1000 kg_fish")
```

It becomes necessary at this point to explicitly declare the units of some outputs, and make clear whether they refer to individual fish within a farm (mean across nruns) or the whole farm (individual fish x population).

| Stat name | Unit | Description |
|-------|-----|------------------------------------|
weight        | g | Mean weight of an individual fish within a farm | Individual |
dw            | g | Mean daily weight change per individual within a farm | Individual |
water_temp    | $^{\circ}$C | Mean daily temperature on farm | Farm |
T_response    | - | Temperature response of all fish within a farm (identical for all fish in a farm) | Farm |
P_excr        | g | Total excreted protein from the entire farm | Farm |
L_excr        | g | Total excreted lipid from the entire farm | Farm |
C_excr        | g | Total excreted carbohydrate from the entire farm | Farm |
P_uneat       | g | Total uneaten protein from the entire farm | Farm |
L_uneat       | g | Total uneaten lipid from the entire farm | Farm |
C_uneat       | g | Total uneaten carbohydrate from the entire farm | Farm |
food_prov     | g | Total food provided to the entire farm | Farm |
food_enc      | g | Total food encountered by each individual fish | Individual |
rel_feeding   | - | Temperature-driven relative feeding rate (identical for all fish in a farm) | Farm |
ing_pot       | g | Total ingestion potential of each (i.e. the maximum that can be eaten) | Individual |
ing_act       | g | Total actual ingestion of feed by fish in the entire farm | Farm |
E_assim       |  |  | Individual |
E_somat       |  |  | Individual |
anab          |  |  | Individual |
catab         |  |  | Individual |
O2            |  |  | Farm |
NH4           |  |  | Farm |
total_excr    | g | Total excretion from the entire farm (P+L+C) | Farm |
total_uneat   | g | Total uneaten feed from the entire farm (P+L+C) | Farm |
metab         |  |  | Individual |
biomass       | g | Mean weight of all fish within a farm (i.e. weight * population) | Farm |
: Summary of model outputs being used in this script. Note that all the outputs are daily values (i.e. value at day = t). None are summed across a production period.

```{r filenames}
#| code-summary: Set up global filenames

# Filenames
# species_params_excel <- c(file = file.path(input_species_param_path, "Species.xlsx"), sheet = "Atlantic salmon")
# pop_params_excel <- c(file = file.path(input_species_param_path, "Population.xlsx"))
# farm_locations_parquet <- file.path(input_farm_coords_path, "farm_coords.parquet")
# farm_coords_file <- file.path(output_farm_data_path, "farm_coords.qs")
# farm_geometry_file <- file.path(output_farm_data_path, "farm_geometry.qs")
# farm_ts_data_file <- file.path(output_farm_data_path, "farm_ts_data.qs")
# species_params_file <- file.path(output_species_data_path, "species_params.qs")
# sens_params_file <- file.path(output_species_data_path, "sens_params.qs")
# pop_params_file <- file.path(output_species_data_path, "pop_params.qs")
# feed_params_file <- file.path(output_species_data_path, "feed_params.qs")
# farm_harvest_file <- file.path(output_farm_data_path, "farm_harvest_size.qs")
```

# Look at raw outputs

```{r raw-outputs}
total_ends <- file.path(output_model_farm_path, "total_ends.qs") %>% 
  qread() %>% 
  mutate(
    feed_group = factor(
      str_remove(feed, "_min|_max"), 
      levels = long_feeds,
      labels = short_feeds
      ),
    feed_type = case_when(
      str_detect(feed, "_min") ~ "min",
      str_detect(feed, "_max") ~ "max",
      T ~ "mean"
      ) %>% as.factor(),
    mean = set_units(mean, "g"),
    sd = set_units(sd, "g"),
    mean_biomass = set_units(mean_biomass, "g_fish"),
    sd_biomass = set_units(sd_biomass, "g_fish"),
    mean_per_biom = set_units(mean_per_biom, "g g_fish-1"),
    sd_per_biom = set_units(sd_per_biom, "g g_fish-1")
  )

cohort_results <- file.path(output_model_cohort_path, "cohort_results.qs") %>% 
  qread() %>% 
  mutate(
    feed_group = factor(
      str_remove(feed, "_min|_max"), 
      levels = long_feeds,
      labels = short_feeds
      ),
    feed_type = case_when(
      str_detect(feed, "_min") ~ "min",
      str_detect(feed, "_max") ~ "max",
      T ~ "mean"
      ) %>% as.factor(),
    mean = set_units(mean, "g"),
    sd = set_units(sd, "g"),
    mean_biomass = set_units(mean_biomass, "g_fish"),
    sd_biomass = set_units(sd_biomass, "g_fish"),
    mean_per_biom = set_units(mean_per_biom, "g g_fish-1"),
    sd_per_biom = set_units(sd_per_biom, "g g_fish-1")
  )
```

```{r basic-stats}
#| code-summary: Code to generate plot
#| fig-height: 12

total_ends %>% 
  filter(!measure %in% c("biomass_stat", "food_prov_stat")) %>% 
  mutate(
    measure = factor(measure, levels = c(
      "C_excr_stat", "C_uneat_stat", 
      "L_excr_stat", "L_uneat_stat", 
      "P_excr_stat", "P_uneat_stat", 
      "total_excr_stat", "total_uneat_stat"
    )),
    mean_per_biom = set_units(mean_per_biom, "g kg_fish-1")
  ) %>% 
  ggplot(aes(x = feed_group, y = mean_per_biom, fill = feed_type)) +
  geom_boxplot() +
  facet_wrap(facets = vars(measure), scales = "free", ncol = 2) +
  prettyplot_600() +
  theme(legend.position = "right")

# | Description | Plant-dominant | Marine-dominant | Novel-inclusive | Change from PD to MD (%) | Change from PD to NI (%) |
# |:--------------------------|:----------:|:----------:|:----------:|:----------:|:----------:|
# | Salmon biomass produced (t)                         | `r bpr1$PD`        | `r bpr1$MD`        | `r bpr1$NI`        | `r coln(bpr2$MD)`    | `r coln(bpr2$NI)`    |
# | Feed provided (t)                                   | `r fpr1$PD`        | `r fpr1$MD`        | `r fpr1$NI`        | `r coln(fpr2$MD)`    | `r coln(fpr2$NI)`    |
# | Feed provided (kg/kg salmon)                        | `r fpr_pb1$PD`     | `r fpr_pb1$MD`     | `r fpr_pb1$NI`     | `r coln(fpr_pb2$MD)` | `r coln(fpr_pb2$NI)` |
# | Uneaten feed (t)                                    | `r tuf1$PD`        | `r tuf1$MD`        | `r tuf1$NI`        | `r coln(tuf2$MD)`    | `r coln(tuf2$NI)`    |
# | Excreted waste (t)                                  | `r tew1$PD`        | `r tew1$MD`        | `r tew1$NI`        | `r coln(tew2$MD)`    | `r coln(tew2$NI)`    |
# | Total waste (E+U, t)                                | `r tow1$PD`        | `r tow1$MD`        | `r tow1$NI`        | `r coln(tow2$MD)`    | `r coln(tow2$NI)`    |
# | Proportion of total waste composed of excretion (%) | `r epw$PD`         | `r epw$MD`         | `r epw$NI`         |                      |                      |
# | Total protein waste (t)                             | `r sum(plc1$PD_P)` | `r sum(plc1$MD_P)` | `r sum(plc1$NI_P)` | `r coln(plc3$MD_P)`  | `r coln(plc3$NI_P)`  |
# | Total carbohydrate waste (t)                        | `r sum(plc1$PD_C)` | `r sum(plc1$MD_C)` | `r sum(plc1$NI_C)` | `r coln(plc3$MD_C)`  | `r coln(plc3$NI_C)`  |
# | Total lipid waste (t)                               | `r sum(plc1$PD_L)` | `r sum(plc1$MD_L)` | `r sum(plc1$NI_L)` | `r coln(plc3$MD_L)`  | `r coln(plc3$NI_L)`  |
# | Proportion of protein waste from excretion (%)      | `r plc2$PD_P`      | `r plc2$MD_P`      | `r plc2$NI_P`      |                      |                      |
# | Proportion of carbohydrate waste from excretion (%) | `r plc2$PD_C`      | `r plc2$MD_C`      | `r plc2$NI_C`      |                      |                      |
# | Proportion of lipid waste from excretion (%)        | `r plc2$PD_L`      | `r plc2$MD_L`      | `r plc2$NI_L`      |                      |                      |
# | Total N from uneaten feed (t)                       | `r niu1$PD`        | `r niu1$MD`        | `r niu1$NI`        | `r coln(niu2$MD)`    | `r coln(niu2$NI)`    |
# | Total N from excreted waste (t)                     | `r nie1$PD`        | `r nie1$MD`        | `r nie1$NI`        | `r coln(nie2$MD)`    | `r coln(nie2$NI)`    |
# | Total N inputs (E+U, t)                             | `r nit1$PD`        | `r nit1$MD`        | `r nit1$NI`        | `r coln(nit2$MD)`    | `r coln(nit2$NI)`    |
# : Summary of all results. Unless otherwise specified, values presented are means across all farms, summed across a single production period. In the % change columns, the colour of the text indicates whether there is an increase (red) or a decrease (green). Some cells of this table are blank - sometimes that means it doesn't make sense to fill that cell, but sometimes it means I haven't got to it yet. {#tbl-results-summary}
```

## Feed provided and lost

```{r feed-prov-lost}
#| code-summary: Code to generate plot
#| fig-cap: Mean food provided and uneaten feed lost to the environment when feeds use minimum (blue), maximum (red) or mean (green) digestibility coefficients.

feed_end <- total_ends %>% 
  filter(measure %in% c("total_uneat_stat", "food_prov_stat"))

feed_end %>% 
  mutate(
    mean_per_biom = set_units(mean_per_biom, "g kg_fish-1"),
    measure = droplevels(measure)
    ) %>% 
  ggplot(aes(x = feed_group, y = mean_per_biom, fill = feed_type, group = feed)) +
  geom_boxplot() +
  facet_wrap(facets = vars(measure), scales = "free") +
  prettyplot_300()
```

## Faeces excreted and proportion of total waste

```{r faeces-excreted}
#| code-summary: Code to generate plot
#| fig-cap: Mean faeces excreted and proportion of total waste coming from faeces when feeds use minimum (blue), maximum (red) or mean (green) digestibility coefficients.

faeces_end <- total_ends %>% 
  filter(measure %in% c("total_excr_stat", "total_uneat_stat")) %>% 
  select(farm_ID, feed, feed_type, feed_group, measure, mean_per_biom) %>% 
  mutate(
    mean_per_biom = set_units(mean_per_biom, "g kg_fish-1") %>% drop_units(),
    measure = droplevels(measure)
    ) %>%
  pivot_wider(
    names_from = "measure",
    values_from = "mean_per_biom"
  ) %>% 
  mutate(
    total_waste = total_excr_stat + total_uneat_stat,
    total_excr_prop = 100*total_excr_stat/total_waste
  ) %>% 
  select(-total_waste, total_uneat_stat) %>% 
  pivot_longer(
    cols = c(total_excr_stat, total_excr_prop),
    names_to = "measure",
    values_to = "value"
  )

faeces_end %>% 
  ggplot(aes(x = feed_group, y = value, fill = feed_type, group = feed)) +
  geom_boxplot() +
  facet_wrap(facets = vars(measure), scales = "free") +
  prettyplot_300()
```

# Farm locations

For some of the outputs of the model, it makes sense to sum them across a production period and/or calculate their values per unit of biomass. 
```{r biomass-location-globals-farm}

farm_locs <- find_read(output_farm_data_path, "geometry") %>% 
  rename(farm_ID = farm_id) %>% 
  mutate(country = as.factor(country))
```

# Daily results

```{r daily-uneaten-excreted}

daily_results_1 <- cohort_results %>% 
  filter(measure %in% c("total_uneat_stat", "total_excr_stat")) %>% 
  select(-c(mean, sd, mean_biomass, sd_biomass, sd_per_biom)) %>% 
  group_by(feed_group, feed_type, feed, measure, prod_t) %>% 
  reframe(
    mean = mean(mean_per_biom) %>% set_units("g g_fish-1") %>% set_units("g kg_fish-1"),
    sd = sd(mean_per_biom) %>% set_units("g g_fish-1") %>% set_units("g kg_fish-1"),
    min = min(mean_per_biom) %>% set_units("g g_fish-1") %>% set_units("g kg_fish-1"),
    max = max(mean_per_biom) %>% set_units("g g_fish-1") %>% set_units("g kg_fish-1")
  )

daily_results_1 %>% 
  ggplot(aes(x = prod_t, y = mean, colour = feed, group = feed)) +
  geom_line() +
  facet_wrap(facets = vars(measure), scales = "free", nrow = 2) +
  theme_classic()
```

# Spatial results

## Total ends

## Daily mean, min, max

```{r}
space_daily_results_1 <- cohort_results %>% 
  filter(measure %in% c("total_uneat_stat", "total_excr_stat")) %>% 
  select(-c(mean, sd, mean_biomass, sd_biomass, sd_per_biom)) %>% 
  group_by(feed_group, feed_type, feed, measure, farm_ID) %>% 
  reframe(
    mean = mean(mean_per_biom) %>% set_units("g g_fish-1") %>% set_units("g kg_fish-1"),
    sd = sd(mean_per_biom) %>% set_units("g g_fish-1") %>% set_units("g kg_fish-1"),
    min = min(mean_per_biom) %>% set_units("g g_fish-1") %>% set_units("g kg_fish-1"),
    max = max(mean_per_biom) %>% set_units("g g_fish-1") %>% set_units("g kg_fish-1")
  ) %>% 
  merge(farm_locs, by = "farm_ID")

p_bigmap_robinson +
  geom_sf(
    data = space_daily_results_1, 
    aes(colour = drop_units(mean), geometry = geometry), 
    size = 2
  ) +
  coord_sf() +
  scale_color_viridis_c(option = "turbo", breaks = seq(10, 35, 5), limits = c(10,36)) + 
  guides(col = guide_colourbar(
    title = expression("Difference in N inputs (kg/t salmon)"),
    direction = "horizontal", position = "bottom",
    label.position = "bottom", title.position = "top",
    title.vjust = 1, title.hjust = 0.5,
    frame.colour = "black", ticks.colour = "black",ticks.linewidth = 1,
    barheight = 1.5, barwidth = 20,
  )) +
  facet_wrap(facets = vars(feed)) +
  prettyplot_300() +
  theme(
    strip.background = element_blank(), 
    strip.text = element_blank(),
    axis.title = element_blank(),
    legend.position = "bottom"
  )
```

# Old stuff

Note that this next block takes a long time to run, almost entirely because of the proper calculation of the ratio standard deviation for the per biomass stats.

```{r, eval=F}
#| label: summed-per-biomass-outputs

further_stats <- c(
  # Nutrients excreted
  "P_excr_stat", "L_excr_stat", "C_excr_stat", 
  # Nutrients uneaten
  "P_uneat_stat", "L_uneat_stat", "C_uneat_stat",
  # Food provided and eaten
  "food_prov_stat", "ing_act_stat",
  # Oxygen consumed, ammonium produced
  "O2_stat", "NH4_stat",
  # PLC uneaten and excreted
  "total_excr_stat", "total_uneat_stat"
)

analysis_names <- further_stats %>% str_remove("_stat")

print(str_c("Starting further stats processing at ", Sys.time()))

prepped_biomass <- farm_biomass %>% 
  select(-measure) %>% 
  rename(biom_mean = mean,biom_sd = sd)

prepped_biomass_produced <- biomass_produced %>% 
  select(-measure) %>% 
  rename(biom_mean = mean, biom_sd = sd) %>% 
  select(farm_ID, feed, biom_mean, biom_sd)

for (fs in seq_along(further_stats)) {
  # Model output
  out <- find_read(output_model_farm_path, further_stats[fs])
  
  # Total summed across the production period
  stat_summed <- out %>% 
    group_by(farm_ID, feed, measure) %>% 
    reframe(
      days = n(),
      total = sum(mean),
      sd = sqrt(sumna(sd^2)),
    ) %>% 
    merge(farm_locs, by = "farm_ID") %>% 
    relocate(country, .before = farm_ID) %>% 
    st_as_sf() %>% 
    mutate(
      days = days %>% set_units("d"),
      total = total %>% set_units("g"),
      sd = sd %>% set_units("g")
    )
  
  qs::qsave(stat_summed, file.path(data_analysis_path, str_c(analysis_names[fs], "_farm_summed.qs")))

  # Total per biomass (/g salmon)
  # This needs the "farm_biomass" global from above
  stat_per_biom <- out %>% 
    merge(
      prepped_biomass, 
      by = c("farm_ID", "feed", "t", "prod_t")
    ) %>% 
    mutate(
      mean_biom = mean/biom_mean,
      sd_biom = (mean/biom_mean) * sqrt((biom_sd/biom_mean)^2 + (sd/mean)^2)
    ) %>% 
    select(-c(mean, sd, biom_mean, biom_sd)) %>% 
    merge(farm_locs, by = "farm_ID") %>% 
    relocate(country, .before = farm_ID) %>% 
    st_as_sf() %>% 
    mutate(
      mean_biom = mean_biom %>% set_units("g g_fish-1"),
      sd_biom = sd_biom %>% set_units("g g_fish-1")
    )
  
  qs::qsave(stat_per_biom, file.path(data_analysis_path, str_c(analysis_names[fs], "_farm_per_biom.qs")))

  # Total per biomass (/g salmon) summed across the production period
  # This needs the "biomass_produced" global from above
  stat_per_biom_summed <- out %>% 
    group_by(farm_ID, feed, measure) %>% 
    reframe(
      days = n(),
      total = sum(mean),
      sd = sqrt(sumna(sd^2)),
    ) %>% 
    select(farm_ID, feed, measure, total, sd) %>% 
    merge(
      prepped_biomass_produced, 
      by = c("farm_ID", "feed")
    ) %>% 
    mutate(
      mean_biom = (total/biom_mean),
      sd_biom = (total/biom_mean) * sqrt((biom_sd/biom_mean)^2 + (sd/total)^2)
    ) %>% 
    select(-c(total, sd, biom_mean, biom_sd)) %>% 
    merge(farm_locs, by = "farm_ID") %>% 
    relocate(country, .before = farm_ID) %>% 
    st_as_sf() %>% 
    mutate(mean_biom = mean_biom %>% set_units("g g_fish-1"),
           sd_biom = sd_biom %>% set_units("g g_fish-1"))
  
  qs::qsave(stat_per_biom_summed, file.path(data_analysis_path, str_c(analysis_names[fs], "_farm_per_biom_summed.qs")))
  
  print(str_c(
    "Finished ", further_stats[fs], " at ", Sys.time(), " --- ", round(100*fs/length(further_stats),1), "% done"
  ))
}

rm(stat_summed, stat_per_biom, stat_per_biom_summed)
```

Similarly, some cohort stats can be expressed per biomass. The cohort stats are only really useful when talking about daily values on an operating farm (with the overlapping cohorts) and average values per day or year.

```{r biomass-location-globals-cohort, eval=F}

cohort_biomass <- find_read(output_model_cohort_path, "biomass_stat")
cohort_biomass %>% filter(farm_ID == 1) %>% pull(t) %>% unique() %>% length()
```

```{r summed-per-biomass-outputs-cohort, eval=F}

further_stats <- c(
  # Nutrients excreted
  "P_excr_stat", "L_excr_stat", "C_excr_stat", 
  # Nutrients uneaten
  "P_uneat_stat", "L_uneat_stat", "C_uneat_stat",
  # Food provided and eaten
  "food_prov_stat", "ing_act_stat",
  # Oxygen consumed, ammonium produced
  "O2_stat", "NH4_stat",
  # PLC uneaten and excreted
  "total_excr_stat", "total_uneat_stat"
)

analysis_names <- further_stats %>% str_remove("_stat")

for (fs in seq_along(further_stats)) {
  # Model output
  out <- find_read(output_model_cohort_path, further_stats[fs])
  
  # # Total summed across the production period
  # stat_summed <- out %>% 
    # group_by(farm_ID, feed, measure) %>% 
    # reframe(
    #   days = n(),
    #   total = sum(mean),
    #   sd = sqrt(sumna(sd^2)),
    # ) %>% 
  #   merge(farm_locs, by = "farm_ID") %>% 
  #   relocate(country, .before = farm_ID) %>% 
  #   st_as_sf() %>% 
  #   mutate(days = days %>% set_units("d"),
  #          total = total %>% set_units("g"),
  #          sd = sd %>% set_units("g"))
  
  # Finish this - I want to have:
  # * Mean output per year (total, and per biomass)
  # * Mean, min and max output per day (total, and per biomass)
  
  # This needs the "cohort_biomass" global from above
  stat_per_biom <- per_biom_coho(out) %>% 
    merge(farm_locs, by = "farm_ID") %>% 
    relocate(country, .before = farm_ID) %>% 
    st_as_sf() %>% 
    mutate(mean_biom = mean_biom %>% set_units("g g_fish-1"),
           sd_biom = sd_biom %>% set_units("g g_fish-1"))

  qs::qsave(stat_per_biom, file.path(data_analysis_path, str_c(analysis_names[fs], "_cohort_per_biom.qs")))
  

  
  print(str_c(
    "Finished ", further_stats[fs], " at ", Sys.time(), " --- ", round(100*fs/length(further_stats),1), "% done"
  ))
}
```

# Biomass and feed provided/consumed questions

```{r biomass-produced-comparisons, eval=F}

biomass_produced <- find_read(output_model_farm_path, "biomass_produced") %>% 
  mutate(feed = factor(feed, 
                       levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
                       labels = c("MD", "PD", "NI"))) %>% 
  pivot_wider(
    names_from = feed,
    values_from = c(mean, sd),
    id_cols = c(farm_ID, measure)
  ) %>% 
  mutate(
    sd_MD = (1/mean_PD) * sqrt(sd_MD^2 + sd_PD^2),
    sd_NI = (1/mean_PD) * sqrt(sd_NI^2 + sd_PD^2),
    mean_MD = (mean_MD-mean_PD)/mean_PD,
    mean_NI = (mean_NI-mean_PD)/mean_PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "_", names_transform = list(feed = as.factor),
    cols = contains(c("sd", "mean"))
  ) %>% 
  merge(farm_locs, by = c("farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
ggplot(biomass_produced, aes(x = country, y = mean, fill = feed)) +
  geom_boxplot()

qs::qsave(biomass_produced, file.path(comparisons_path, "biomass_produced.qs"))
rm(biomass_produced)
```

## Are fish fed different feeds given more or less feed?

```{r food-provided-comparison, eval=F}

# Summed across the whole production period
food_prov_farm_summed <- find_read(data_analysis_path, "food_prov_farm_summed") %>% 
  st_drop_geometry() %>% 
  mutate(feed = factor(feed, 
                       levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
                       labels = c("MD", "PD", "NI"))) %>% 
  pivot_wider(
    names_from = feed,
    values_from = c(total, sd), values_fn = list(total = drop_units, sd = drop_units),
    id_cols = c(country, farm_ID, measure, days)
  ) %>% 
  mutate(
    sd_MD = (1/total_PD) * sqrt(sd_MD^2 + sd_PD^2),
    sd_NI = (1/total_PD) * sqrt(sd_NI^2 + sd_PD^2),
    total_MD = (total_MD-total_PD)/total_PD,
    total_NI = (total_NI-total_PD)/total_PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "_", names_transform = list(feed = as.factor),
    cols = contains(c("sd", "total"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(food_prov_farm_summed, aes(x = country, y = total, fill = feed)) +
#   geom_boxplot()

qs::qsave(food_prov_farm_summed, file.path(comparisons_path, "food_prov_farm_summed.qs"))
rm(food_prov_farm_summed)

# Summed across the whole production period, per biomass of fish produced -  is this identical to FCE?
food_prov_farm_per_biom_summed <- find_read(data_analysis_path, "food_prov_farm_per_biom_summed") %>% 
  st_drop_geometry() %>% 
  mutate(
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = feed, names_sep = ".", 
    values_from = c(mean_biom, sd_biom), values_fn = list(mean_biom = drop_units, sd_biom = drop_units),
    id_cols = c(country, farm_ID, measure)
  ) %>% 
  mutate(
    sd_biom.MD = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.MD^2),
    sd_biom.NI = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.NI^2),
    mean_biom.MD = (mean_biom.MD-mean_biom.PD)/mean_biom.PD,
    mean_biom.NI = (mean_biom.NI-mean_biom.PD)/mean_biom.PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "[.]", names_transform = list(feed = as.factor),
    cols = contains(c("sd_biom", "mean_biom"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
ggplot(food_prov_farm_per_biom_summed, aes(x = country, y = mean_biom, fill = feed)) +
  geom_boxplot()

qs::qsave(food_prov_farm_per_biom_summed, file.path(comparisons_path, "food_prov_farm_per_biom_summed.qs"))
rm(food_prov_farm_per_biom_summed)
```

# Total inputs (mass) questions
## Does uneaten feed increase or decrease with novel feeds?

```{r uneaten-feed-comparisons, eval=F}

# Summed across the whole production period
total_uneat_farm_summed <- find_read(data_analysis_path, "total_uneat_farm_summed") %>% 
  st_drop_geometry() %>% 
  mutate(feed = factor(feed, 
                       levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
                       labels = c("MD", "PD", "NI"))) %>% 
  pivot_wider(
    names_from = feed,
    values_from = c(total, sd), values_fn = list(total = drop_units, sd = drop_units),
    id_cols = c(country, farm_ID, measure, days)
  ) %>% 
  mutate(
    sd_MD = (1/total_PD) * sqrt(sd_MD^2 + sd_PD^2),
    sd_NI = (1/total_PD) * sqrt(sd_NI^2 + sd_PD^2),
    total_MD = (total_MD-total_PD)/total_PD,
    total_NI = (total_NI-total_PD)/total_PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "_", names_transform = list(feed = as.factor),
    cols = contains(c("sd", "total"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(total_uneat_farm_summed, aes(x = country, y = total, fill = feed)) +
#   geom_boxplot()

qs::qsave(total_uneat_farm_summed, file.path(comparisons_path, "total_uneat_farm_summed.qs"))
rm(total_uneat_farm_summed)

# Summed across the whole production period, per biomass of fish produced
total_uneat_farm_per_biom_summed <- find_read(data_analysis_path, "total_uneat_farm_per_biom_summed") %>% 
  st_drop_geometry() %>% 
  mutate(
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = feed, names_sep = ".", 
    values_from = c(mean_biom, sd_biom), values_fn = list(mean_biom = drop_units, sd_biom = drop_units),
    id_cols = c(country, farm_ID, measure)
  ) %>% 
  mutate(
    sd_biom.MD = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.MD^2),
    sd_biom.NI = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.NI^2),
    mean_biom.MD = (mean_biom.MD-mean_biom.PD)/mean_biom.PD,
    mean_biom.NI = (mean_biom.NI-mean_biom.PD)/mean_biom.PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "[.]", names_transform = list(feed = as.factor),
    cols = contains(c("sd_biom", "mean_biom"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(total_uneat_farm_per_biom_summed, aes(x = country, y = mean_biom, fill = feed)) +
#   geom_boxplot()

qs::qsave(total_uneat_farm_per_biom_summed, file.path(comparisons_path, "total_uneat_farm_per_biom_summed.qs"))
rm(total_uneat_farm_per_biom_summed)
```

## Does total inputs (mass) of each macronutrient increase or decrease with novel feeds?

```{r, eval=F}
#| label: PLC-mass-inputs-comparison

PLC_uneat_excr_farm_summed <- rbind(
    find_read(data_analysis_path, "P_uneat_farm_summed"), 
    find_read(data_analysis_path, "L_uneat_farm_summed"), 
    find_read(data_analysis_path, "C_uneat_farm_summed"),
    find_read(data_analysis_path, "P_excr_farm_summed"), 
    find_read(data_analysis_path, "L_excr_farm_summed"), 
    find_read(data_analysis_path, "C_excr_farm_summed")
  ) %>% 
  st_drop_geometry() %>% 
  mutate(
    measure = droplevels(measure),
    measure = factor(
      measure,
      labels = str_remove(levels(measure), "_stat")
    ),
    macro = as.factor(str_split_i(measure, "_", 1)),
    measure = as.factor(str_split_i(measure, "_", 2)),
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  )
# Check that it looks reasonable
# ggplot(PLC_uneat_excr_farm_summed, aes(x = country, y = total, fill = feed)) +
#   geom_boxplot() +
#   facet_grid(cols = vars(macro), rows = vars(measure))

qs::qsave(PLC_uneat_excr_farm_summed, file.path(data_analysis_path, "PLC_uneat_excr_farm_summed.qs"))
rm(PLC_uneat_excr_farm_summed)


# Summed across the whole production period
PLC_uneat_excr_farm_summed <- rbind(
    find_read(data_analysis_path, "P_uneat_farm_summed"), 
    find_read(data_analysis_path, "L_uneat_farm_summed"), 
    find_read(data_analysis_path, "C_uneat_farm_summed"),
    find_read(data_analysis_path, "P_excr_farm_summed"), 
    find_read(data_analysis_path, "L_excr_farm_summed"), 
    find_read(data_analysis_path, "C_excr_farm_summed")
  ) %>% 
  st_drop_geometry() %>% 
  mutate(
    measure = droplevels(measure),
    measure = factor(
      measure,
      labels = str_remove(levels(measure), "_stat")
    ),
    macro = as.factor(str_split_i(measure, "_", 1)),
    measure = as.factor(str_split_i(measure, "_", 2)),
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = c(feed, macro),
    values_from = c(total, sd), values_fn = list(total = drop_units, sd = drop_units),
    id_cols = c(country, farm_ID, measure, days)
  ) %>% 
  mutate(
    sd_MD_P = (1/total_PD_P) * sqrt(sd_MD_P^2 + sd_PD_P^2),
    sd_NI_P = (1/total_PD_P) * sqrt(sd_NI_P^2 + sd_PD_P^2),
    total_MD_P = (total_MD_P-total_PD_P)/total_PD_P,
    total_NI_P = (total_NI_P-total_PD_P)/total_PD_P,
    sd_MD_P = (1/total_PD_P) * sqrt(sd_MD_P^2 + sd_PD_P^2),
    sd_NI_P = (1/total_PD_P) * sqrt(sd_NI_P^2 + sd_PD_P^2),
    total_MD_L = (total_MD_L-total_PD_L)/total_PD_L,
    total_NI_L = (total_NI_L-total_PD_L)/total_PD_L,
    sd_MD_P = (1/total_PD_P) * sqrt(sd_MD_P^2 + sd_PD_P^2),
    sd_NI_P = (1/total_PD_P) * sqrt(sd_NI_P^2 + sd_PD_P^2),
    total_MD_C = (total_MD_C-total_PD_C)/total_PD_C,
    total_NI_C = (total_NI_C-total_PD_C)/total_PD_C
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed", "macro"), names_sep = "_", names_transform = list(feed = as.factor, macro = as.factor),
    cols = contains(c("sd", "total"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(PLC_uneat_excr_farm_summed, aes(x = country, y = total, fill = feed)) +
#   geom_boxplot() +
#   facet_grid(cols = vars(macro), rows = vars(measure))

qs::qsave(PLC_uneat_excr_farm_summed, file.path(comparisons_path, "PLC_uneat_excr_farm_summed.qs"))
rm(PLC_uneat_excr_farm_summed)

# Summed across the whole production period, per biomass of fish produced
PLC_uneat_excr_farm_per_biom_summed <- rbind(
    find_read(data_analysis_path, "P_uneat_farm_per_biom_summed"), 
    find_read(data_analysis_path, "L_uneat_farm_per_biom_summed"), 
    find_read(data_analysis_path, "C_uneat_farm_per_biom_summed"),
    find_read(data_analysis_path, "P_excr_farm_per_biom_summed"), 
    find_read(data_analysis_path, "L_excr_farm_per_biom_summed"), 
    find_read(data_analysis_path, "C_excr_farm_per_biom_summed")
  ) %>% 
  st_drop_geometry() %>% 
  mutate(
    measure = droplevels(measure),
    measure = factor(
      measure,
      labels = str_remove(levels(measure), "_stat")
    ),
    macro = as.factor(str_split_i(measure, "_", 1)),
    measure = as.factor(str_split_i(measure, "_", 2)),
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  rename(
    mean.biom = mean_biom,
    sd.biom = sd_biom
  ) %>% 
  pivot_wider(
    names_from = c(feed, macro),
    values_from = c(mean.biom, sd.biom), values_fn = list(mean.biom = drop_units, sd.biom = drop_units),
    id_cols = c(country, farm_ID, measure)
  ) %>% 
  mutate(
    sd.biom_MD_P = (1/mean.biom_PD_P) * sqrt(sd.biom_MD_P^2 + sd.biom_PD_P^2),
    sd.biom_NI_P = (1/mean.biom_PD_P) * sqrt(sd.biom_NI_P^2 + sd.biom_PD_P^2),
    mean.biom_MD_P = (mean.biom_MD_P-mean.biom_PD_P)/mean.biom_PD_P,
    mean.biom_NI_P = (mean.biom_NI_P-mean.biom_PD_P)/mean.biom_PD_P,
    sd.biom_MD_L = (1/mean.biom_PD_L) * sqrt(sd.biom_MD_L^2 + sd.biom_PD_L^2),
    sd.biom_NI_L = (1/mean.biom_PD_L) * sqrt(sd.biom_NI_L^2 + sd.biom_PD_L^2),
    mean.biom_MD_L = (mean.biom_MD_L-mean.biom_PD_L)/mean.biom_PD_L,
    mean.biom_NI_L = (mean.biom_NI_L-mean.biom_PD_L)/mean.biom_PD_L,
    sd.biom_MD_C = (1/mean.biom_PD_C) * sqrt(sd.biom_MD_C^2 + sd.biom_PD_C^2),
    sd.biom_NI_C = (1/mean.biom_PD_C) * sqrt(sd.biom_NI_C^2 + sd.biom_PD_C^2),
    mean.biom_MD_C = (mean.biom_MD_C-mean.biom_PD_C)/mean.biom_PD_C,
    mean.biom_NI_C = (mean.biom_NI_C-mean.biom_PD_C)/mean.biom_PD_C
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed", "macro"), names_sep = "_", names_transform = list(feed = as.factor, macro = as.factor),
    cols = contains(c("sd.biom", "mean.biom"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(PLC_uneat_excr_farm_per_biom_summed, aes(x = country, y = mean.biom, fill = feed)) +
#   geom_boxplot() +
#   facet_grid(cols = vars(macro), rows = vars(measure))

qs::qsave(PLC_uneat_excr_farm_per_biom_summed, file.path(comparisons_path, "PLC_uneat_excr_farm_per_biom_summed.qs"))
rm(PLC_uneat_excr_farm_per_biom_summed)
```

## Does the proportion of total inputs (mass) attributed to each macronutrient increase or decrease with novel feeds?

```{r, eval=F}
#| label: macronutrient-proportion-comparison

# Summed across the whole production period
PLC_proportion_farm_summed_1 <- rbind(
    find_read(data_analysis_path, "P_uneat_farm_summed"), 
    find_read(data_analysis_path, "L_uneat_farm_summed"), 
    find_read(data_analysis_path, "C_uneat_farm_summed"),
    find_read(data_analysis_path, "P_excr_farm_summed"), 
    find_read(data_analysis_path, "L_excr_farm_summed"), 
    find_read(data_analysis_path, "C_excr_farm_summed")
  ) %>% 
  st_drop_geometry() %>% 
  mutate(
    measure = droplevels(measure),
    measure = factor(
      measure,
      labels = str_remove(levels(measure), "_stat")
    ),
    macro = as.factor(str_split_i(measure, "_", 1)),
    measure = as.factor(str_split_i(measure, "_", 2)),
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = macro,
    values_from = c(total, sd), values_fn = list(total = drop_units, sd = drop_units),
    id_cols = c(country, farm_ID, feed, measure, days)
  ) %>% 
  mutate(
    total_sum = total_P+total_C+total_L,
    sd_sum = sqrt(sd_P^2+sd_C^2+sd_L^2),
    prop_P = total_P/total_sum,
    prop_C = total_C/total_sum,
    prop_L = total_L/total_sum,
    sd_P = ratio_sd(total_P, sd_P, total_sum, sd_sum),
    sd_C = ratio_sd(total_C, sd_C, total_sum, sd_sum),
    sd_L = ratio_sd(total_L, sd_P, total_sum, sd_sum),
  ) %>% 
  select(-contains(c("total", "sum"))) %>% 
  pivot_longer(
    names_to = c(".value", "macro"), names_sep = "_", names_transform = list(macro = as.factor),
    cols = contains(c("sd", "prop"))
  )

# Check that it looks reasonable
# ggplot(PLC_proportion_farm_summed_1, aes(x = measure, y = prop, fill = feed)) +
#   geom_col(position = "dodge") +
#   facet_grid(rows = vars(macro))

qs::qsave(PLC_proportion_farm_summed_1, file.path(data_analysis_path, "PLC_proportion_farm_summed.qs"))

PLC_proportion_farm_summed_2 <- PLC_proportion_farm_summed_1 %>% 
  pivot_wider(
    names_from = c(feed, macro),
    values_from = c(prop, sd),
    id_cols = c(country, farm_ID, measure, days)
  ) %>% 
  mutate(
    sd_MD_P = (1/prop_PD_P) * sqrt(sd_MD_P^2 + sd_PD_P^2),
    sd_NI_P = (1/prop_PD_P) * sqrt(sd_NI_P^2 + sd_PD_P^2),
    prop_MD_P = (prop_MD_P-prop_PD_P)/prop_PD_P,
    prop_NI_P = (prop_NI_P-prop_PD_P)/prop_PD_P,
    sd_MD_L = (1/prop_PD_L) * sqrt(sd_MD_L^2 + sd_PD_L^2),
    sd_NI_L = (1/prop_PD_L) * sqrt(sd_NI_L^2 + sd_PD_L^2),
    prop_MD_L = (prop_MD_L-prop_PD_L)/prop_PD_L,
    prop_NI_L = (prop_NI_L-prop_PD_L)/prop_PD_L,
    sd_MD_C = (1/prop_PD_C) * sqrt(sd_MD_C^2 + sd_PD_C^2),
    sd_NI_C = (1/prop_PD_C) * sqrt(sd_NI_C^2 + sd_PD_C^2),
    prop_MD_C = (prop_MD_C-prop_PD_C)/prop_PD_C,
    prop_NI_C = (prop_NI_C-prop_PD_C)/prop_PD_C
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed", "macro"), names_sep = "_", names_transform = list(feed = as.factor, macro = as.factor),
    cols = contains(c("sd", "prop"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(PLC_proportion_farm_summed_2, aes(x = macro, y = prop, fill = feed)) +
#   geom_boxplot() +
#   facet_grid(cols = vars(measure))

qs::qsave(PLC_proportion_farm_summed_2, file.path(comparisons_path, "PLC_proportion_farm_summed.qs"))
rm(PLC_proportion_farm_summed_1, PLC_proportion_farm_summed_2)
```

# N inputs questions

This is very similar to the previous set of questions, however in this set only the protein outputs are considered and converted to nitrogen ($N=P\times 6.25$). 

## Does N from uneaten feed increase or decrease with novel feeds?

```{r, eval=F}
#| label: uneaten-feed-N-comparison

# Summed across the whole production period
N_uneat_farm_summed <- find_read(data_analysis_path, "P_uneat_farm_summed") %>% 
  st_drop_geometry() %>% 
  mutate(
    total = total * 6.25,
    sd = sd * 6.25,
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = feed,
    values_from = c(total, sd), values_fn = list(total = drop_units, sd = drop_units),
    id_cols = c(country, farm_ID, measure, days)
  ) %>% 
  mutate(
    sd_MD = (1/total_PD) * sqrt(sd_MD^2 + sd_PD^2),
    sd_NI = (1/total_PD) * sqrt(sd_NI^2 + sd_PD^2),
    total_MD = (total_MD-total_PD)/total_PD,
    total_NI = (total_NI-total_PD)/total_PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "_", names_transform = list(feed = as.factor),
    cols = contains(c("sd", "total"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(N_uneat_farm_summed, aes(x = country, y = total, fill = feed)) +
#   geom_boxplot()

qs::qsave(N_uneat_farm_summed, file.path(comparisons_path, "N_uneat_farm_summed.qs"))
rm(N_uneat_farm_summed)

# Summed across the whole production period, per biomass of fish produced
N_uneat_farm_per_biom_summed <- find_read(data_analysis_path, "P_uneat_farm_per_biom_summed") %>% 
  st_drop_geometry() %>% 
  mutate(
    mean_biom = mean_biom * 6.25,
    sd_biom = mean_biom * 6.25,
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = feed, names_sep = ".", 
    values_from = c(mean_biom, sd_biom), values_fn = list(mean_biom = drop_units, sd_biom = drop_units),
    id_cols = c(country, farm_ID, measure)
  ) %>% 
  mutate(
    sd_biom.MD = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.MD^2),
    sd_biom.NI = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.NI^2),
    mean_biom.MD = (mean_biom.MD-mean_biom.PD)/mean_biom.PD,
    mean_biom.NI = (mean_biom.NI-mean_biom.PD)/mean_biom.PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "[.]", names_transform = list(feed = as.factor),
    cols = contains(c("sd_biom", "mean_biom"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(N_uneat_farm_per_biom_summed, aes(x = country, y = mean_biom, fill = feed)) +
#   geom_boxplot()

qs::qsave(N_uneat_farm_per_biom_summed, file.path(comparisons_path, "N_uneat_farm_per_biom_summed.qs"))
rm(N_uneat_farm_per_biom_summed)
```

## Does N excretion increase or decrease with novel feeds?

```{r, eval=F}
#| label: excreted-N-comparison

# Summed across the whole production period
N_excr_farm_summed <- find_read(data_analysis_path, "P_excr_farm_summed") %>% 
  st_drop_geometry() %>% 
  mutate(
    total = total * 6.25,
    sd = sd * 6.25,
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = feed,
    values_from = c(total, sd), values_fn = list(total = drop_units, sd = drop_units),
    id_cols = c(country, farm_ID, measure, days)
  ) %>% 
  mutate(
    sd_MD = (1/total_PD) * sqrt(sd_MD^2 + sd_PD^2),
    sd_NI = (1/total_PD) * sqrt(sd_NI^2 + sd_PD^2),
    total_MD = (total_MD-total_PD)/total_PD,
    total_NI = (total_NI-total_PD)/total_PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "_", names_transform = list(feed = as.factor),
    cols = contains(c("sd", "total"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(N_excr_farm_summed, aes(x = country, y = total, fill = feed)) +
#   geom_boxplot()

qs::qsave(N_excr_farm_summed, file.path(comparisons_path, "N_excr_farm_summed.qs"))
rm(N_excr_farm_summed)

# Summed across the whole production period, per biomass of fish produced
N_excr_farm_per_biom_summed <- find_read(data_analysis_path, "P_excr_farm_per_biom_summed") %>% 
  st_drop_geometry() %>% 
  mutate(
    mean_biom = mean_biom * 6.25,
    sd_biom = mean_biom * 6.25,
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = feed, names_sep = ".", 
    values_from = c(mean_biom, sd_biom), values_fn = list(mean_biom = drop_units, sd_biom = drop_units),
    id_cols = c(country, farm_ID, measure)
  ) %>% 
  mutate(
    sd_biom.MD = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.MD^2),
    sd_biom.NI = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.NI^2),
    mean_biom.MD = (mean_biom.MD-mean_biom.PD)/mean_biom.PD,
    mean_biom.NI = (mean_biom.NI-mean_biom.PD)/mean_biom.PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "[.]", names_transform = list(feed = as.factor),
    cols = contains(c("sd_biom", "mean_biom"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(N_excr_farm_per_biom_summed, aes(x = country, y = mean_biom, fill = feed)) +
#   geom_boxplot()

qs::qsave(N_excr_farm_per_biom_summed, file.path(comparisons_path, "N_excr_farm_per_biom_summed.qs"))
rm(N_excr_farm_per_biom_summed)
```

```{r, eval=F}
#| label: total-N-comparison

# Summed across the whole production period
N_total_farm_summed <- rbind(
  find_read(data_analysis_path, "P_excr_farm_summed"),
  find_read(data_analysis_path, "P_uneat_farm_summed")
  ) %>% 
  st_drop_geometry() %>% 
  mutate(
    total = total * 6.25,
    sd = sd * 6.25,
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  group_by(country, farm_ID, feed, days) %>% 
  reframe(
    total = sum(total),
    sd = sqrt(sum(sd^2))
  ) %>% 
  mutate(measure = as.factor("total")) %>% 
  relocate(measure, .after = feed) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(N_total_farm_summed, aes(x = country, y = total, fill = feed)) +
#   geom_boxplot()

qs::qsave(N_total_farm_summed, file.path(data_analysis_path, "N_total_farm_summed.qs"))

N_total_farm_summed <- N_total_farm_summed %>% 
  st_drop_geometry() %>% 
  pivot_wider(
    names_from = feed,
    values_from = c(total, sd), values_fn = list(total = drop_units, sd = drop_units),
    id_cols = c(country, farm_ID, measure, days)
  ) %>% 
  mutate(
    sd_MD = (1/total_PD) * sqrt(sd_MD^2 + sd_PD^2),
    sd_NI = (1/total_PD) * sqrt(sd_NI^2 + sd_PD^2),
    total_MD = (total_MD-total_PD)/total_PD,
    total_NI = (total_NI-total_PD)/total_PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "_", names_transform = list(feed = as.factor),
    cols = contains(c("sd", "total"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
ggplot(N_total_farm_summed, aes(x = country, y = total, fill = feed)) +
  geom_boxplot()

qs::qsave(N_total_farm_summed, file.path(comparisons_path, "N_total_farm_summed.qs"))



# Summed across the whole production period, per biomass of fish produced
N_excr_farm_per_biom_summed <- find_read(data_analysis_path, "P_excr_farm_per_biom_summed") %>% 
  st_drop_geometry() %>% 
  mutate(
    mean_biom = mean_biom * 6.25,
    sd_biom = mean_biom * 6.25,
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    )
  ) %>% 
  pivot_wider(
    names_from = feed, names_sep = ".", 
    values_from = c(mean_biom, sd_biom), values_fn = list(mean_biom = drop_units, sd_biom = drop_units),
    id_cols = c(country, farm_ID, measure)
  ) %>% 
  mutate(
    sd_biom.MD = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.MD^2),
    sd_biom.NI = (1/mean_biom.PD) * sqrt(sd_biom.PD^2 + sd_biom.NI^2),
    mean_biom.MD = (mean_biom.MD-mean_biom.PD)/mean_biom.PD,
    mean_biom.NI = (mean_biom.NI-mean_biom.PD)/mean_biom.PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "[.]", names_transform = list(feed = as.factor),
    cols = contains(c("sd_biom", "mean_biom"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(N_excr_farm_per_biom_summed, aes(x = country, y = mean_biom, fill = feed)) +
#   geom_boxplot()

qs::qsave(N_excr_farm_per_biom_summed, file.path(comparisons_path, "N_excr_farm_per_biom_summed.qs"))
rm(N_excr_farm_per_biom_summed)
```

```{r, eval=F}

N_total_farm_summed <- rbind(
  find_read(data_analysis_path, "P_excr_farm_summed"),
  find_read(data_analysis_path, "P_uneat_farm_summed")
  ) %>% 
  st_drop_geometry() %>% 
  mutate(
    total = total * 6.25,
    sd = sd * 6.25,
    feed = factor(
      feed, 
      levels = c("marine_dominant", "plant_dominant", "novel_inclusive"),
      labels = c("MD", "PD", "NI")
    ),
    measure = factor(
      measure, 
      levels = c("P_excr_stat", "P_uneat_stat"),
      labels = c("excr", "uneat")
      )
  ) %>% 
  rbind(N_total_farm_summed_0)
  
  pivot_wider(
    names_from = feed,
    values_from = c(total, sd), values_fn = list(total = drop_units, sd = drop_units),
    id_cols = c(country, farm_ID, measure, days)
  ) %>% 
  mutate(
    sd_MD = (1/total_PD) * sqrt(sd_MD^2 + sd_PD^2),
    sd_NI = (1/total_PD) * sqrt(sd_NI^2 + sd_PD^2),
    total_MD = (total_MD-total_PD)/total_PD,
    total_NI = (total_NI-total_PD)/total_PD
  ) %>% 
  select(-contains("PD")) %>% 
  pivot_longer(
    names_to = c(".value", "feed"), names_sep = "_", names_transform = list(feed = as.factor),
    cols = contains(c("sd", "total"))
  ) %>% 
  merge(farm_locs, by = c("country", "farm_ID")) %>% 
  st_as_sf()

# Check that it looks reasonable
# ggplot(N_excr_farm_summed, aes(x = country, y = total, fill = feed)) +
#   geom_boxplot()

qs::qsave(N_excr_farm_summed, file.path(comparisons_path, "N_excr_farm_summed.qs"))
rm(N_excr_farm_summed)
```
