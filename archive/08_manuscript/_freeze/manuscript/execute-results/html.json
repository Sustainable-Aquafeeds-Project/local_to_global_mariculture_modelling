{
  "hash": "917d115db5a4e616ec714f060dccd71c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Local to global N input modelling\"\n# Author roles: \"writing – original draft\", \"writing – review & editing\", \"formal analysis\", \"funding acquisition\", \"conceptualization\", \"data curation\", \"investigation\", \"methodology\", \"project administration\", \"resources\", \"software\", \"supervision\", \"validation\", \"visualization\"\nauthor:\n  - name: Tormey Reimer\n    orcid: 0000-0002-5983-2798\n    corresponding: true\n    email: tormey.reimer@utas.edu.au\n    role: \n      - methodology: supporting\n      - analysis: lead\n      - writing: lead\n    affil-id: [1,2]\n  - name: Richard S. Cottrell\n    orcid: 0000-0002-6499-7503\n    corresponding: false\n    roles: \n      - conceptualization: lead\n      - methodology: lead\n      - writing: supporting\n    # affil-id: [1,2]\n  - name: Alexandra Johne\n    orcid: 0000-0002-2816-7983\n    corresponding: false\n    roles: \n      - methodology: supporting\n    affil-id: 3\n  - name: Sowdamini Sesha Prasad\n    # orcid: \n    corresponding: false\n    roles: \n      - methodology: supporting\n    # affil-id: [3,2]\n  - name: Marceau Cormery\n    # orcid: \n    corresponding: false\n    roles: \n      - methodology: supporting\n    # affil-id: [3,2]\n  - name: Gage Clawson\n    # orcid: \n    corresponding: false\n    roles: \n      - methodology: supporting\n    # affil-id: [3,2]\n  - name: Scott Hadley\n    # orcid: \n    corresponding: false\n    roles: \n      - methodology: supporting\n    # affil-id: [3,2]\n  - name: Helen Hamilton\n    # orcid: \n    corresponding: false\n    roles: \n      - conceptualization: supporting\n    # affil-id: [3,2]\n  - name: Benjamin S. Halpern\n    # orcid: \n    corresponding: false\n    roles: \n      - conceptualization: supporting\n    # affil-id: [3,2]\n  - name: Catriona Macleod\n    # orcid: \n    corresponding: false\n    roles: \n      - conceptualization: supporting\n    # affil-id: [3,2]\n  - name: Camille White\n    # orcid: \n    corresponding: false\n    roles: \n      - conceptualization: supporting\n    # affil-id: [3,2]\n  - name: Julia L. Blanchard\n    # orcid: \n    corresponding: false\n    roles: \n      - conceptualization: supporting\n      - methodology: supporting\n      - analysis: supporting\n      - editing: supporting\n    # affil-id: [3,2]\n    \naffiliations:\n  - id: 1\n    name: Institute for Marine and Antarctic Studies\n    group: Fisheries & Aquaculture\n    address: 29 Nubeena Crescent\n    city: Taroona\n    region: TAS\n    country: Australia\n    postal-code: 7053\n    url: https://www.imas.utas.edu.au/\n  - id: 2\n    name: Centre for Marine Socioecology\n    url: https://marinesocioecology.org/\n  - id: 1\n    name: Institute for Marine and Antarctic Studies\n    group: Ecology & Biodiversity\n    # address: 29 Nubeena Crescent\n    # city: Taroona\n    # region: TAS\n    # country: Australia\n    # postal-code: 7053\n    url: https://www.imas.utas.edu.au/\n  # - id: 3\n  #   name: Heriott-Watt University, Institute for Life and Earth Sciences\n  #   department: School of Energy, Geoscience, Infrastructure and Society\n  #   address: Franklin Road\n  #   city: Stromness\n  #   region: Orkney\n  #   country: United Kingdom\n  #   postal-code: KW16 3AN\n  #   url: https://www.hw.ac.uk/\n# keywords:\n#   - keyword\n#   - keyword\n# abstract: |\n#   Any new aquaculture venture...\n# plain-language-summary: |\n#   Plain language summary goes here....\n# key-points:\n#   - Point 1\n#   - Point 2\nbibliography: [\"refs.bib\", \"manual-refs.bib\"]\n\nformat: \n  html:\n    theme: simplex\n    css: [\"extra.css\"]\n    code-fold: true\n    code-overflow: wrap\n    toc: true\n    toc-expand: true\n    toc-location: left\n    lang: en-GB\n    grid:\n      sidebar-width: 350px\n      body-width: 1200px\n      margin-width: 250px\n      gutter-width: 2em\n  # pdf:\n  #   papersize: a4\n  #   linestretch: 1.15\n  #   link-citations: true\n  #   keep-tex: true\n  #   template-partials:\n  #     - \"title.tex\"\n  #   include-in-header:\n  #     file: \"header_extra.tex\"\n\nfilters:\n  - acronyms\n  \nexecute:\n  eval: true\n  echo: false\n  warning: false\n  message: false\n  cache: true\n  freeze: auto\n  \nknitr: \n  opts_chunk:\n    fig.align: center\n    fig.width: 8.5\n\neditor: source\n---\n\n::: {.cell .hidden layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nlibrary(magrittr)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(tidyr)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'tidyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:magrittr':\n\n    extract\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(stringr)\nlibrary(ggplot2)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'ggplot2' was built under R version 4.4.3\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(ggh4x)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'ggh4x' was built under R version 4.4.3\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nhere() starts at C:/Users/treimer/Documents/R-temp-files/local_to_global_mariculture_modelling\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(ggpubr)\nlibrary(patchwork)\nlibrary(qs)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'qs' was built under R version 4.4.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nqs 0.27.3. Announcement: https://github.com/qsbase/qs/issues/103\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(arrow)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'arrow'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:magrittr':\n\n    is_in\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:utils':\n\n    timestamp\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(targets)\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLinking to GEOS 3.13.0, GDAL 3.10.1, PROJ 9.5.1; sf_use_s2() is TRUE\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(terra)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nterra 1.8.50\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'terra'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:arrow':\n\n    buffer\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:patchwork':\n\n    area\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:ggpubr':\n\n    rotate\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:tidyr':\n\n    extract\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:magrittr':\n\n    extract, inset\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(rnaturalearth)\nlibrary(rnaturalearthdata)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'rnaturalearthdata'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:rnaturalearth':\n\n    countries110\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(dtplyr)\nlibrary(furrr)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: future\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(RColorBrewer)\nlibrary(purrr)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'purrr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:magrittr':\n\n    set_names\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(future)\nlibrary(readxl)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'readxl' was built under R version 4.4.3\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(units)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: package 'units' was built under R version 4.4.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nudunits database from C:/Users/treimer/AppData/Local/R/cache/R/renv/cache/v5/windows/R-4.4/x86_64-w64-mingw32/units/0.8-7/5d0b024902d5da97a2b64f002e92a869/units/share/udunits/udunits2.xml\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(conflicted)\nlibrary(lubridate)\nlibrary(RColorBrewer)\nconflicts_prefer(dplyr::select(), dplyr::filter(), dplyr::intersect(), .quiet = T)\n# This markdown uses TinyTex - install with tinytex::install_tinytex()\n\ninstall_unit(\"gfish\")\ninstall_unit(\"kgfish\", \"1000 gfish\")\ninstall_unit(\"tfish\", \"1000 kgfish\")\n```\n:::\n\n::: {.cell .hidden layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nsource(here(\"00_model_functions.R\"))\n\n# Input paths\ninput_farm_coords_path <- here() %>% file.path(\"data\", \"_general_data\", \"farm_locations\")\ninput_farm_sst_path <- here() %>% file.path(\"data\", \"_general_data\", \"SST\")\ninput_species_param_path <- here() %>% file.path(\"data\", \"atlantic_salmon\", \"params\")\ninput_feed_profile_path <- here() %>% file.path(\"data\", \"_general_data\", \"diets\")\n\n# Output paths\noutput_farm_data_path <- here() %>% file.path(\"outputs\", \"farm_data\")\noutput_species_data_path <- here() %>% file.path(\"outputs\", \"species_data\")\noutput_sens_data_path <- here() %>% file.path(\"outputs\", \"sensitivity_data\")\noutput_farm_growth_data_path <- here() %>% file.path(\"outputs\", \"farm_growth_data\")\noutput_cohort_growth_data_path <- here() %>% file.path(\"outputs\", \"cohort_growth_data\")\ndata_analysis_path <- here() %>% file.path(\"outputs\", \"data_analysis\")\n\n# Filenames\nfarm_coords_file <- file.path(output_farm_data_path, \"farm_coords.qs\")\nspecies_params_file <- file.path(output_species_data_path, \"species_params.qs\")\npop_params_file <- file.path(output_species_data_path, \"pop_params.qs\")\nfeed_params_file <- file.path(output_species_data_path, \"feed_params.qs\")\nsens_params_file <- file.path(output_species_data_path, \"sens_params.qs\")\nsens_results_files <- file.path(output_sens_data_path) %>% str_subset(\"results\")\n\nspecies_params <- qread(species_params_file)\npop_params <- qread(pop_params_file)\n```\n:::\n\n\n\n# Introduction\n\n[This is a note create with the `aside` class.]{.aside}\n\nAquaculture is now the dominant form of aquatic animal food (herein ‘seafood’) production and is expected to be the primary way we meet future seafood demand. Freshwater systems will likely continue to provide the majority of farmed seafood but marine aquaculture is also poised to expand substantially in numerous areas. Farmed marine fish and invertebrates are produced near exclusively in coastal waters, and nearly three quarters of this production is dependent on human-made feeds. Nearshore locations and feed inputs are necessary to maintain profitable and productive farming operations but coastal aquaculture generates a number of challenges. In the crowded coastal zone, aquaculture operations can conflict with other stakeholder uses such as recreation, fishing, renewable energy, transport, and tourism. \nAnd while farming marine fish typically generates a far smaller nutrient footprint than livestock farming, the overt nature of aquaculture in nearshore regions and evidence of  localised nutrient impacts around fish farms remains a primary public and scientific concern. Identifying strategies that reduce ecosystem impacts from fish farm waste therefore represents an important goal for improving marine aquaculture sustainability and maintaining the sector’s social licence to operate. \n\nAquaculture feeds represent an important lever for reducing nutrient waste impacts around fish farms. Like all farmed animals, fish and invertebrates must digest the nutrients contained in feeds before they can be used for growth. Any nutrients left undigested are egested as solid waste, and dissolved wastes are excreted as metabolic waste products. Further, some feed inevitably remains uneaten and is lost to the surrounding ecosystem. Particulate organic matter (both feed and faeces) that settles can simplify benthic communities as the oxygen demand from its decomposition drives the production of sulphides that kill less mobile faunal, encouraging a lower diversity of opportunistic scavengers and the growth of bacterial mats (e.g., Beggiatoa spp). Thus, the chemical composition of the ingredients used in aquaculture feeds and their digestibility for the farmed species has significant implications for the nature and reactivity of the waste generate by marine aquaculture.\n\nFirstly the overall volume of nutrient waste is dictated by the nature and intensity of production, that is the farm size, the density of farmed animals and the feed requirements and efficiency of the species grown. SecondlDeposition of waste is heavily influenced by water depth and current speed at the farming site. Once\n\nAs farmed fish and invertebrates are fed, whatever\t\n\nNutand its impact on marine ecosystems is influenced by many factors. \n* Farm size\n* Depth\n* Current speed\n* Benthic impact - sediment type/faunal assemblages/wider marine community\n* High turnover environments - nitrogen enriched areas\n* Feed influences all of these things\n\nThe primary source of organic waste from fed aquaculture production comes from the excretion and faeces of the farmed animals and through uneaten feed that dissolves in the water column or settles on the benthos. The nature and impact of this waste are influenced heavily by the composition of the feeds fed to farmed animals. \n\n## P2\n\n* Waste from aquaculture farms and it’s impact is influenced by many things but the composition of feeds plays a central role.\n* Waste from aquaculture farms has multiple sources. \n* The primary source of organic waste comes from the faeces and excretion of the fish or invertebrates.\n* Uneaten feed produced another key source.\n* The nature and impact of this waste are influenced heavily by the composition of the feeds fed to farmed animals\n* Many marine fish are naturally carnivorous so diets used to be high in fishmeal and oil but increasing fishmeal and oil prices along with concerns over the sustainability of marine ingredients have led to a reduction in their use across multiple farmed taxa\n* In lieu of fishmeal and oil, many plant-based ingredients such as soy protein concentrate, canola oil, and wheat gluten have replaced them. \n* Changes in feed composition influences the digestibility of the nutrients held in each feed and can alter the composition of waste.\n* Of particular concern are changes (increases) to the presence of reactive nitrogen and phosphorus in coastal waters that could have an effect on eutrophication. \n\n## P3\n\n* Whether or not nutrients lead to eutrophication depends on the sensitivity of the receiving environment\n* Ecosystems that are already enriched through natural processes and whose biota is well adapted to substantial fluxes in available nutrients (e.g. upwelling zones, dynamic coastal communities) may be less sensitive while oligotrophic ecosystem are likely to see considerable changes under nutrient enrichment scenarios.\n* To understand the impact of aquaculture waste under present day or future scenarios we need to quantify the volume, nature, and location of mariculture waste and determine the sensitivity of the receiving environments to that waste. Yet only recent estimates even give us the estimated location of marine farms let alone the volume of nature of the waste produced.\nTo address this gap, we use existing maps of mariculture location with a bioenergtic model\n\n# Methods\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden  code-summary=\"Get general farm info\"}\nfarms_to_omit <- file.path(input_farm_coords_path, \"atlantic_salmon_farms_to_omit.qs\") %>% qs::qread()\nfarm_ts_data <- file.path(output_farm_data_path, \"farm_ts_data.qs\") %>% qs::qread()\nfarm_coords <- file.path(output_farm_data_path, \"farm_coords.qs\") %>% qs::qread() %>% \n    mutate(hemisphere = case_when(lat < 0 ~ \"S\", T ~ \"N\") %>% as.factor()) \n\nfarms_geometry <- file.path(output_farm_data_path, \"farm_geometry.qs\") %>% qs::qread() %>% \n  rename(farm_ID = farm_id)\n\nsorted_countries <- farm_coords %>% \n  merge(farms_geometry, by = \"farm_ID\") %>% \n  group_by(country) %>% \n  reframe(av_lat = mean(lat)) %>% \n  arrange(-av_lat) %>% \n  pull(country) %>% \n  unique()\n```\n:::\n\n\n\n## Farm temperature forcings\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden  code-summary=\"Get the farm temperature forcings\"}\nfarm_temp_means <- farm_ts_data %>% \n  group_by(farm_ID) %>% \n  reframe(mean_temp = mean(temp_c)) %>% \n  merge(farms_geometry, by = \"farm_ID\") %>% \n  merge(farm_coords, by = \"farm_ID\") %>% \n  dplyr::filter(!farm_ID %in% farms_to_omit)\n\noverall_mean <- mean(farm_temp_means$mean_temp)\noverall_sd <- sd(farm_temp_means$mean_temp)\n\nrm(farm_ts_data)\n```\n:::\n\n\n\nMean daily temperatures at the farms globally ranged from  from 6$^{\\circ}$ to 16.7$^{\\circ}$, with an overall mean of 10.1$^{\\circ}$ ($\\pm$ 1.8 SD).\nFarms with a mean temperature of $\\leq 6^\\circ$C were excluded (4 farms). The total number of farms included in this analysis was therefore 2717.\n\n\n\n::: {#cell-fig-farm-mean-temps .cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nworldmap <- ne_countries(scale = \"medium\", returnclass = \"sf\")\n\np1 <- ggplot(data = worldmap, aes(geometry = geometry)) +\n  geom_sf(fill = \"white\", color = \"dimgray\") +\n  geom_sf(data = farm_temp_means, aes(colour = mean_temp), size = 1.5) +\n  coord_sf() +\n  theme_classic() \n\np2 <- farm_temp_means %>% \n  ggplot(aes(y = mean_temp, x = abs(lat), colour = country)) +\n  geom_point(size = 2.5) +\n  scale_colour_brewer(palette = \"Set1\") +\n  labs(x = expression(\"Absolute latitude (\"*degree*\")\"), y = expression(\"Mean temperature (\"*degree*\"C)\")) +\n  theme_classic() +\n  theme(legend.position = \"top\", legend.title = element_blank())\n\np3 <- farm_temp_means %>% \n  mutate(hemisphere = case_when(lat < 0 ~ \"S\", T ~ \"N\")) %>% \n  ggplot(aes(x = mean_temp, fill = hemisphere)) +\n  geom_histogram(position = \"identity\", colour = \"black\", alpha = 0.5, binwidth = 0.5) +\n  labs(x = expression(\"Mean temperature (\"*degree*\"C)\"), y = \"Frequency\") +\n  theme_classic() +\n  theme(legend.position = \"top\", legend.title = element_blank())\n\n(p2 + p3) / p1 + plot_layout(heights = c(1, 1.5))\n```\n\n::: {.cell-output-display}\n![Potential options for showing farm site mean temperatures. Top left: Mean temperature by latitude across countries. Top right: Frequency distribution of mean temperatures by hemisphere. Bottom: global distribution of mean temperatures.\n](manuscript_files/figure-html/fig-farm-mean-temps-1.png){#fig-farm-mean-temps fig-align='center' width=912}\n:::\n:::\n\n\n\n## Model and approach\n\nWe adapted the methods of @baldan_r_2018 to create a bioenergetic model that simulates individual growth and farm-scale production for Atlantic salmon and the resultant nutrient waste in the form of excess labile nitrogen and phosphorus. \nThe model simulates growth at an individual level, calculating the change in individual weight through time using:\n\n$$\n\\frac{dw}{dt} = \\frac{A-C}{\\epsilon}\n$$\n\nWhere $w=$ is wet weight (t), $t=$ time (d), $A=$ anabolic rate (J t$^{-1}$), $C=$ the catabolic rate (J t$^{-1}$), $\\epsilon=$ energy density of body tissues (J t$^{-1}$). \nIndividual models were then upscaled using monte-carlo simulations to simulate size structure in a population. Size differences were achieved through different initial starting weights and ingestion rates for different finfish species. All individuals have a fixed mortality rate to simulate stocking and harvesting. \n\n[Need to put the cohort concept (and harvest timing) in here.]{.aside}\n\n\n\n::: {#cell-fig-cohorts .cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nfnms <- output_cohort_growth_data_path %>% \n  list.files(full.names = T) %>% \n  str_subset(\"biomass\")\n\ndf <- fnms[1] %>% read_parquet() %>% \n  filter(feed == \"reference\") %>% \n  mutate(mean = set_units(mean, \"g\") %>% set_units(\"t\"),\n         sd = set_units(sd, \"g\") %>% set_units(\"t\"))\n\nggplot(df, aes(x = yday, y = mean, ymin = mean-sd, ymax = mean+sd, colour = as.factor(cohort))) +\n  geom_line(linewidth = 0.75) +\n  geom_ribbon(linetype = \"dotted\", alpha = 0) +\n  scale_x_continuous(breaks = seq(0, 2000, 200)) +\n  labs(y = \"Farm biomass\", x = \"Day of the year\") +\n  theme_classic() +\n  theme(legend.position = \"none\", aspect.ratio = 0.75)\n\nyrs <- max(df$yday)/365\nharvests <- df %>% \n  group_by(cohort) %>% \n  reframe(mean = maxna(mean),\n          sd = maxna(sd))\n\nsum(harvests$mean)/yrs\nmean(harvests$sd)/yrs\n```\n:::\n\n\n\n### Feeding rate\n\n\n\n::: {#cell-fig-functional-response-to-temperature .cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\ndf <- data.frame(water_temp = seq(-5, 26, 0.25))\ndf$feeding <- sapply(FUN = feeding_rate, X = df$water_temp, species_params = species_params)\ndf <- df %>% \nmutate(ing_pot = pop_params['meanImax'] * (pop_params['meanW']^species_params['m']) * feeding,\n       food_prov = NA)\nfor (i in 1:nrow(df)) {\n  df$food_prov[i] <- food_prov_rate(pop_params = pop_params, rel_feeding = df$feeding[i], ing_pot = df$ing_pot[i], \n                                    ing_pot_10 = pop_params['meanImax'] * (pop_params['meanW']^species_params['m']) * 0.1)\n}\ndf$ing_pot <- df$ing_pot/maxna(df$ing_pot)\ndf$food_prov <- df$food_prov/maxna(df$ing_pot)\n\ndf %>% \n  ggplot(aes(x = water_temp, y = ing_pot)) +\n  geom_line(linewidth = 0.75) +\n  geom_line(aes(y = food_prov), linewidth = 0.75, linetype = \"dotted\") +\n  scale_y_continuous(breaks = seq(0,1.5,0.25)) +\n  scale_x_continuous(breaks = seq(-5,30,5), limits = c(-5,26)) +\n  labs(x = expression(\"Water temperature (\"*degree*\"C)\"), y = \"Relative food ingested/provided\") +\n  theme_classic() +\n  theme(text = element_text(colour = \"black\", family = \"serif\", size = 12))\n```\n:::\n\n\n\n## Production parameters\n\n* Salmon cohorts were always grown for 548 days\n* Salmon cohorts were put out in annually Spring, on day 274 when farm latitude < 0 and day 121 when farm latitude > 0.\n* Cohorts were put out every year, such that there was an annual overlap of 183 days where one cohort was nearing harvest and another was being initialised. \n\n## Parameterisation for Atlantic salmon\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden  code-summary=\"Get parameter and sensitivity data\"}\nparams <- file.path(output_species_data_path, \"sens_params.qs\") %>% qs::qread()\n\nparam_names <- tibble::tribble(\n  ~name,        ~lab,\n  \"alpha\",      bquote(alpha),\n  \"epsprot\",    bquote(epsilon[\"P\"]),\n  \"epslip\",     bquote(epsilon[\"L\"]),\n  \"epscarb\",    bquote(epsilon[\"C\"]),\n  \"epsO2\",      bquote(epsilon[\"O\"[2]]),\n  \"pk\",         bquote(\"pk\"),\n  \"k0\",         bquote(\"k\"[0]),\n  \"m\",          bquote(\"m\"),\n  \"n\",          bquote(\"n\"),\n  \"betac\",      bquote(beta*\"C\"),\n  \"Tma\",        bquote(\"T\"[\"max\"]),\n  \"Toa\",        bquote(\"T\"[\"opt\"]),\n  \"Taa\",        bquote(\"T\"[\"min\"]),\n  \"omega\",      bquote(omega),\n  \"a\",          bquote(\"a\"),\n  \"k\",          bquote(\"k\"),\n  \"eff\",        bquote(\"eff\"),\n  \"meanW\",      bquote(bar(\"W\")),\n  \"deltaW\",     bquote(Delta*\"W\"), \n  \"meanImax\",   bquote(bar(\"I\"[\"max\"])),\n  \"deltaImax\",  bquote(Delta*\"I\"[\"max\"]),\n  \"overFmean\",  bquote(bar(\"F\")),\n  \"overFdelta\", bquote(Delta*\"F\"),\n  \"mortmyt\",    bquote(\"mort\")\n)\n```\n:::\n\n\n\nTable @tbl-params shows the parameter values used to model the growth of farmed Atlantic salmon.\n\n| Parameter | Value | Units | Description | Reference | \n|:-------:|:----:|:----:|:----------------|:-------------------------|\n| $\\alpha$ | 0.04 | - | Feeding catabolism coefficient | *Salvelinus alpinus*, *Oncorhynchus mykiss* (temps: 8–13$^{\\circ}$C) [@broekhuizen_modelling_1994] | \n| $\\epsilon_{P}$ | 2.36\\times 10^{4} | J g protein$^{-1}$ | Energy content of protein | @baldan_r_2018 | \n| $\\epsilon_{L}$ | 3.62\\times 10^{4} | J g lipid$^{-1}$ | Energy content of lipid | @baldan_r_2018 |\n| $\\epsilon_{C}$ | 1.72\\times 10^{4} | J g carbohydrate$^{-1}$ | Energy content of carbohydrate | @baldan_r_2018 |\n| $\\epsilon_{O_2}$ | 1.34\\times 10^{4} | J g O2$^{-1}$ | Energy consumed by the respiration of 1 g of oxygen | @elliott_energy_1975 |\n| pk | 0.05 | d$^{-1}$ | Temperature coefficient for the fasting catabolism | @macnaughton_using_2019 |\n| $k_0$ | 0.003 | - | Fasting catabolism at 0 $^{^\\circ}$C | @macnaughton_using_2019 |\n| m | 0.75 | - | Weight exponent for anabolism | Experimentally-derived alue over a range of *Oncorhynchus*, *Perca* and *Salmo* species (temps: 8–13$^{\\circ}$C) [@broekhuizen_modelling_1994] | \n| n | 1 | - | Weight exponent for catabolism | @baldan_r_2018 |\n| $\\beta C$ | 0.3234 | - | Shape coefficient for the feeding function | Fish size range: 2.25 $\\pm$ 0.49 – 11.5 $\\pm$ 5.29 g, temperature ranges: 5–24$\\^{\\circ}$C. Coefficent for mean daily energy intake of the moderately fast growing group, 0.4398 (mean fast group), 0.2214 (mean slow group) [@jonsson_thermal_2001] | \n| $T_{max}$ | 26 | $^{^\\circ}$C | Maximum lethal temperature | Juvenile *Oncorhynchus tshawytscha* (19.8 $\\pm$ 0.02 g, acclimation temp: 15$^{^\\circ}$C, 19${\\circ}$C) [@poletto_unusual_2017] |\n| $T_{opt}$ | 16 | $^{^\\circ}$C | Optimal temperature | Fish size range: 2.25 $\\pm$ 0.49 – 11.5 $\\pm$ 5.29 g, temperature ranges: 5–24$^{^\\circ}$C [@jonsson_thermal_2001]. Alt value: 14°C [@handeland_effect_2008], *Salmo salar* initial size: 77.0 $\\pm$ 14.6 g, temps: 6, 10, 14, 18${\\circ}$C | \n| $T_{min}$ | 2 | $^{^\\circ}$C | Lowest feeding temperature | Fish essentially stop feeding when below 2$^{\\circ}$C [@vadboncoeur_lowering_2023] | \n| $\\omega$ | 0.6542 | g O2 / g | Oxygen consumption:weight loss ratio | Calibrated value from @baldan_r_2018 | \n| a | 2669 | J g tissue$^{-1}$ | Energy content of fish tissue | Alt value: 17.02350 (nls model fitted to female Atlantic salmon data extracted and transformed from @jonsson_energy_2003 [@van_tien_development_2016] |\n| k | 0.1715 | - | Weight exponent for energy content | Alt value: 1.65175 (nls model fitted to female Atlantic salmon data extracted and transformed from @jonsson_energy_2003 [@van_tien_development_2016] |\n| eff | 0.97 | - | Food ingestion efficiency | Range: 95-97% ingestion efficiency [@uglem_does_2020] | \n| $\\overline{W}$ | 125 | g | Dry weight mean | Range of 100-150 given so used a mean of 125 and sd of 10 which over 1000 draws from a normal distribution delivers a minimum and maximum close to these numbers [@dempsey_estimating_2023] | \n| $\\Delta{W}$ | 10 | g | Dry weight standard deviation | Range of 100-150 given so used a mean of 125 and sd of 10 which over 1000 draws from a normal distribution delivers a minimum and maximum close to these numbers [@dempsey_estimating_2023] | \n| $\\overline{I_{max}}$ | 0.035 | g g$^{-1}$ fish day$^{-1}$ | Ingestion rate mean | [FAO](https://www.fao.org/fileadmin/user_upload/affris/docs/tabl10.pdf) |\n| $\\Delta{I_{max}}$ | 0.005 | g g$^{-1}$ fish day$^{-1}$ | Ingestion rate standard deviation | [FAO](https://www.fao.org/fileadmin/user_upload/affris/docs/tabl10.pdf) |\n| $\\overline{F}$ | 0.015 | g g$^{-1}$ fish$ | Overfeeding rate mean |    |\n| $\\Delta{F}$ | 0.0045 | g g$^{-1}$ fish$ | Overfeeding rate standard deviation |    |\n| mort | 5.99798\\times 10^{-4} | d$^{-1}$ | Natural mortality rate | @tvete_towards_2023 |\n: Model growth parameters for Atlantic salmon {#tbl-params}\n\n### Testing parameter sensitivity\n\nParameter sensitivity was tested by varying each parameter in @tbl-params by $\\pm 10$% and calculating sensitivity as:\n\n$$\nS_p = \\frac{(P_{1.1} - P_{0.9})}{0.2 \\times P_1}\n$$\n\nwhere $S$ is the sensitivity of the measured variable to changes in parameter $p$, and $P_{1.1}$, $P_{0.9}$, and $P_{1}$ are the value of the measured variable when the model is run with parameter $p$ at 110%, 90%, and 100% of its value respectively. \n\n* All parameters in Table @tbl-params were tested across all farms (all temperatures)\n* Used a population of 100 in each farm\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nsens_weight <- output_sens_data_path %>% \n  list.files(full.names = T) %>% \n  str_subset(\"results\") %>% \n  str_subset(\"weight\") %>% \n  qs::qread()\n\nsens_excr <- output_sens_data_path %>% \n  list.files(full.names = T) %>% \n  str_subset(\"results\") %>% \n  str_subset(\"total_excr\") %>% \n  qs::qread() \n\nsens_data <- rbind(sens_weight, sens_excr) %>% \n  mutate(adj_param = factor(adj_param, levels = param_names$name))\n```\n:::\n\n\n\nLooking at @fig-param-sens-weight:\n\n* The most sensitive parameter by far is $m$ (the weight exponent for anabolism), followed closely by $n$ the (weight exponent for catabolism)\n* These two are also relatively uncertain, as $m$ was taken from *Salmo trutta* measurements in a fairly old paper [@broekhuizen_modelling_1994] and $n$ was taken from @baldan_r_2018 which did not specifically look at Atlantic salmon. There must be more up-to-date measurements for Atlantic salmon in particular. \n\n\n\n::: {#cell-fig-param-sens-weight .cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nsens_data %>% \n  ggplot(aes(x = adj_param, y = mean_sens, ymin = mean_sens - sd_sens, ymax = mean_sens + sd_sens, fill = measure)) +\n  geom_col(position = position_dodge(), width = 0.95, colour = \"black\", alpha = 0.75) +\n  # geom_errorbar(position = position_dodge(width = 0.95), width = 0.3) +\n  geom_hline(aes(yintercept = 0), linetype = \"dashed\") +\n  scale_y_continuous(breaks = seq(-30,30,5), limits = c(-10,30)) +\n  scale_x_discrete(limits = rev(param_names$name), labels = rev(param_names$lab)) +\n  scale_fill_manual(values = c(weight = \"salmon\", total_excr = \"steelblue\")) +\n  # scale_fill_manual(values = c(\"weight\" = \"salmon\", \"uneat\" = \"steelblue\", \"excr\" = \"darkgreen\")) +\n  labs(x = \"Adjusted parameter\", y = \"Sensitivity\") +\n  theme_classic() + \n  theme(legend.position = \"none\", \n        strip.text = element_blank(), \n        aspect.ratio = 0.8,\n        text = element_text(size = 12),\n        axis.title.y = element_blank()) +\n  coord_flip()\n```\n\n::: {.cell-output-display}\n![Impact of increasing each model parameter by 10% on final farm biomass (red) and total excreted nutrients (blue) over the whole production period.](manuscript_files/figure-html/fig-param-sens-weight-1.png){#fig-param-sens-weight fig-align='center' width=816}\n:::\n:::\n\n\n\n## Modelled experimental feeds {#sec-feeds}\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nfeed_pal <- c(\"past\" = brewer.pal(9, \"Set1\")[1], \"reference\" = brewer.pal(9, \"Set1\")[2], \"future\" = brewer.pal(9, \"Set1\")[3])\nfeed_params <- file.path(output_species_data_path, \"feed_params.qs\") %>% qs::qread()\n\ndf <- feed_params[[\"reference\"]]\ncontribP_1 <- df[[\"Proteins\"]]$proportion*df[[\"Proteins\"]]$macro\ntP_1 <- sum(contribP_1)\ndigestP_1 <- sum(df[[\"Proteins\"]]$digest * contribP_1)/tP_1\n\ncontribL_1 <- df[[\"Lipids\"]]$proportion*df[[\"Lipids\"]]$macro\ntL_1 <- sum(contribL_1)\ndigestL <- sum(df[[\"Lipids\"]]$digest * contribL_1)/tL_1\n\ncontribC_1 <- df[[\"Carbohydrates\"]]$proportion*df[[\"Carbohydrates\"]]$macro\ntC_1 <- sum(contribC_1)\ndigestC_1 <- sum(df[[\"Carbohydrates\"]]$digest * contribC_1)/tC_1\n\ndf <- feed_params[[\"past\"]]\ncontribP_2 <- df[[\"Proteins\"]]$proportion*df[[\"Proteins\"]]$macro\ntP_2 <- sum(contribP_2)\ndigestP_2 <- sum(df[[\"Proteins\"]]$digest * contribP_2)/tP_2\n\ncontribL_2 <- df[[\"Lipids\"]]$proportion*df[[\"Lipids\"]]$macro\ntL_2 <- sum(contribL_2)\ndigestL <- sum(df[[\"Lipids\"]]$digest * contribL_2)/tL_2\n\ncontribC_2 <- df[[\"Carbohydrates\"]]$proportion*df[[\"Carbohydrates\"]]$macro\ntC_2 <- sum(contribC_2)\ndigestC_2 <- sum(df[[\"Carbohydrates\"]]$digest * contribC_2)/tC_2\n\ndf <- feed_params[[\"future\"]]\ncontribP_3 <- df[[\"Proteins\"]]$proportion*df[[\"Proteins\"]]$macro\ntP_3 <- sum(contribP_3)\ndigestP_3 <- sum(df[[\"Proteins\"]]$digest * contribP_3)/tP_3\n\ncontribL_3 <- df[[\"Lipids\"]]$proportion*df[[\"Lipids\"]]$macro\ntL_3 <- sum(contribL_3)\ndigestL <- sum(df[[\"Lipids\"]]$digest * contribL_3)/tL_3\n\ncontribC_3 <- df[[\"Carbohydrates\"]]$proportion*df[[\"Carbohydrates\"]]$macro\ntC_3 <- sum(contribC_3)\ndigestC_3 <- sum(df[[\"Carbohydrates\"]]$digest * contribC_3)/tC_3\n```\n:::\n\n\n\n* Feed came from [@cottrell_origins_nodate; @cottrell_global_2020]\n* The reference feed is 37.8% protein, 36.5% lipid, 20.4% carbohydrate. \n* The past feed is 49.8% protein, 27.1% lipid, 16.6% carbohydrate. \n* The future feed is 47.7% protein, 32.9% lipid, 13.9% carbohydrate. \n* Within the reference feed, protein is overall 89.2% digestible, lipid is overall 96% digestible, and carbohydrate is overall 69.6% digestible.\n* Within the reference feed, protein is overall 90.5% digestible, lipid is overall 96% digestible, and carbohydrate is overall 79.7% digestible.\n* Within the reference feed, protein is overall 86.2% digestible, lipid is overall 96% digestible, and carbohydrate is overall 69.3% digestible.\n\n## Population and biomass estimates\n\nNew method is to take the average predicted individual harvest size for each farm, then working backwards with the standard mortality rate to generate a population for each farm that will produce the correct tonnage for each farm. @fig-harvest-size shows the  average individual harvest size at each farm as predicted by the fish-growth model, which was used to create the population inputs for the farm-level growth curves. \n\n\n\n::: {#cell-fig-harvest-size .cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nfile.path(output_farm_data_path, \"farm_harvest_size.qs\") %>% \n  qread() %>% \n  mutate(weight = weight %>% set_units(\"g\") %>% set_units(\"kg\")) %>% \n  select(c(farm_ID, weight)) %>% \n  ggplot(aes(x = weight)) +\n  geom_histogram(binwidth = 0.25, colour = \"black\", fill = \"salmon\", alpha = 0.75) +\n  scale_y_continuous(limits = c(0,500)) +\n  labs(y = \"Frequency\", x = \"Harvest weight\") +\n  theme_classic() +\n  theme(\n    legend.position = \"none\", \n    aspect.ratio = 0.75\n  )\n```\n\n::: {.cell-output-display}\n![Frequency distribution of harvest sizes across global farms, as predicted by the fish growth model](manuscript_files/figure-html/fig-harvest-size-1.png){#fig-harvest-size fig-align='center' width=816}\n:::\n:::\n\n\n\nThis means that the population estimates aren't actual fish numbers, they're just a method that allows each farm location to approximate of the correct tonnage produced while to allowing comparisons between the different feeds. \n\n## Biomass produced\n\n\n\n::: {.cell layout-align=\"center\"}\n:::: aside\n\n```{.r .cell-code .hidden}\ncoho_biom <- qs::qread(file.path(data_analysis_path, \"biomass_produced_comparison.qs\"))\n\ncoho_biom %>% \n  ggplot(aes(x = tonnes_per_farm, y = mean, colour = country)) +\n  geom_point(size = 2.5) +\n  geom_abline(slope = 1, intercept = 0, linetype = \"dashed\") +\n  theme_classic() +\n  scale_x_continuous(limits = c(0,1700)) +\n  scale_y_continuous(limits = c(0,1700)) +\n  scale_colour_brewer(palette = \"Set1\") +\n  labs(y = \"Modelled biomass produced (t)\", x = \"Observed biomass produced (t)\") +\n  theme_classic() +\n  theme(legend.position = \"top\", legend.title = element_blank())\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Removed 20 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Modelled vs observed salmon biomass produced](manuscript_files/figure-html/biomass produced-1.png){fig-align='center' width=816}\n:::\n::::\n:::\n\n\n\n## Species vulnerability layers\n\n# Results\n\n* Main point is the difference between feeds (kg/t salmon).\n* Also interesting to see if difference between feeds varies geographically (correlates with mean/median/max temperature?)\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nfarmrun_files <- file.path(output_cohort_growth_data_path) %>% \n  list.files(full.names = T)\n\nqs::qread(farmrun_files[1]) %>% names()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"weight_stat\"      \"dw_stat\"          \"water_temp_stat\"  \"T_response_stat\" \n [5] \"P_excr_stat\"      \"L_excr_stat\"      \"C_excr_stat\"      \"P_uneat_stat\"    \n [9] \"L_uneat_stat\"     \"C_uneat_stat\"     \"food_prov_stat\"   \"food_enc_stat\"   \n[13] \"rel_feeding_stat\" \"ing_pot_stat\"     \"ing_act_stat\"     \"E_assim_stat\"    \n[17] \"E_somat_stat\"     \"anab_stat\"        \"catab_stat\"       \"O2_stat\"         \n[21] \"NH4_stat\"         \"total_excr_stat\"  \"total_uneat_stat\" \"metab_stat\"      \n[25] \"biomass_stat\"    \n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nweight <- purrr::map(farmrun_files, function(f) {qs::qread(f)[[\"weight_stat\"]]}) %>% bind_rows()\nbiomass <- purrr::map(farmrun_files, function(f) {qs::qread(f)[[\"biomass_stat\"]]}) %>% bind_rows()\n```\n:::\n\n\n\n## Uneaten feed\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden  code-summary=\"Load and prep uneaten feed data\"}\nuneaten_total <- farmrun_files %>% \n  purrr::map(function(f) {qs::qread(f)[[\"total_uneat_stat\"]]}) %>% \n  bind_rows() %>% \n  merge(biomass, by = c(\"farm_ID\", \"feed\", \"t\")) %>% \n  rename(uneat_mean = mean.x, biomass_mean = mean.y,\n         uneat_sd = sd.x, biomass_sd = sd.y) %>% \n  mutate(uneat_sd = uneat_sd/uneat_mean,\n         biomass_sd = biomass_sd/biomass_mean,\n         uneat_biom_mean = uneat_mean/biomass_mean,\n         uneat_biom_sd = sqrt(uneat_sd^2+biomass_sd^2)*uneat_biom_mean)\n\nuneaten_total_stats <- uneaten_total %>% \n  group_by(feed, farm_ID) %>% \n  reframe(total = sum(uneat_biom_mean)) %>% \n  group_by(feed) %>% \n  reframe(min = minna(total),\n          max = maxna(total),\n          mean = meanna(total)) %>% \n  mutate(min = min %>% set_units(\"g gfish-1\") %>% set_units(\"g kgfish-1\"),\n         max = max %>% set_units(\"g gfish-1\") %>% set_units(\"g kgfish-1\"),\n         mean = mean %>% set_units(\"g gfish-1\") %>% set_units(\"g kgfish-1\")) %>% \n  mutate(min = round(min,2),\n         max = round(max,2),\n         mean = round(mean,2))\n```\n:::\n\n\n\n* Total reference uneaten feed across a cohort (548 days) ranged from 48.46 to 48.46 g kg$^{-1}$, with a mean of 61.71.\n* There was very little difference between the past and future feeds and the reference feed. Uneaten past feed ranged from \n48.72 to 48.72 g kg$^{-1}$ (mean of 62.17) while uneaten future feed ranged from \n48.73 to 48.73 g kg$^{-1}$ (mean of 62.05).\n* @fig-total-uneaten-perday shows the range of total uneaten feed per day across countries.\n\n\n\n::: {#cell-fig-total-uneaten-perday .cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nuneaten_total %>% \n  merge(farms_geometry, by = \"farm_ID\") %>% \n  mutate(uneat_biom_mean = uneat_biom_mean %>% set_units(\"g gfish-1 d-1\") %>% set_units(\"g kgfish-1 d-1\"),\n         country = factor(country, levels = sorted_countries)) %>% \n  ggplot(aes(x = country, y = uneat_biom_mean, fill = feed)) +\n  geom_boxplot() +\n  theme_classic() +\n  scale_fill_manual(values = feed_pal) +\n  labs(y = \"Uneaten feed\", x = \"Country\")\n```\n\n::: {.cell-output-display}\n![](manuscript_files/figure-html/fig-total-uneaten-perday-1.png){#fig-total-uneaten-perday fig-align='center' width=912}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nuneaten_P <- farmrun_files %>% purrr::map(function(f) {qs::qread(f)[[\"P_uneat_stat\"]]}) %>% bind_rows()\nuneaten_L <- farmrun_files %>% purrr::map(function(f) {qs::qread(f)[[\"L_uneat_stat\"]]}) %>% bind_rows()\nuneaten_C <- farmrun_files %>% purrr::map(function(f) {qs::qread(f)[[\"C_uneat_stat\"]]}) %>% bind_rows()\n\nuneaten_all <- uneaten_total %>% \n  select(-contains(\"biom\")) %>% \n  merge(uneaten_P, by = c(\"farm_ID\", \"feed\", \"t\")) %>% \n  merge(uneaten_L, by = c(\"farm_ID\", \"feed\", \"t\")) %>% \n  merge(uneaten_C, by = c(\"farm_ID\", \"feed\", \"t\")) %>% \n  select(-c(contains(\"sd\")))\n```\n:::\n\n\n\n* The composition of the uneaten feed is (obviously) the same as the total feed composition (@sec-feeds).\n\n## Excreted faeces\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden  code-summary=\"Load and prep all excretion data\"}\n# The following reads in all the total excretion data and converts the mean and sd values into values/biomass\nexcreted_total <- farmrun_files %>% \n  purrr::map(function(f) {qs::qread(f)[[\"total_excr_stat\"]]}) %>% \n  bind_rows() %>% \n  merge(biomass, by = c(\"farm_ID\", \"feed\", \"t\")) %>% \n  rename(excr_mean = mean.x, biomass_mean = mean.y,\n         excr_sd = sd.x, biomass_sd = sd.y) %>% \n  mutate(excr_sd = excr_sd/excr_mean,\n         biomass_sd = biomass_sd/biomass_mean,\n         excr_biom_mean = excr_mean/biomass_mean,\n         excr_biom_sd = sqrt(excr_sd^2+biomass_sd^2)*excr_biom_mean)\n\nexcreted_total_stats <- excreted_total %>% \n  group_by(feed, farm_ID) %>% \n  reframe(total = sum(excr_biom_mean)) %>% \n  group_by(feed) %>% \n  reframe(min = minna(total),\n          max = maxna(total),\n          mean = meanna(total)) %>% \n  mutate(min = min %>% set_units(\"g gfish-1\") %>% set_units(\"g kgfish-1\"),\n         max = max %>% set_units(\"g gfish-1\") %>% set_units(\"g kgfish-1\"),\n         mean = mean %>% set_units(\"g gfish-1\") %>% set_units(\"g kgfish-1\")) %>% \n  mutate(min = round(min,2),\n         max = round(max,2),\n         mean = round(mean,2))\n```\n:::\n\n\n\n* Total reference excreted faeces across a cohort (548 days) ranged from 194.24 to 295.9 g kg$^{-1}$, with a mean of 247.38.\n* There was very little difference between the past and future feeds and the reference feed. Uneaten past feed ranged from \n154.33 to 236.05 g kg$^{-1}$ (mean of 196.94 g kg$^{-1}$) while uneaten future feed ranged from \n202.55 to 308.61 g kg$^{-1}$ (mean of 257.91 g kg$^{-1}$).\n* @fig-total-excreted-perday shows the range of total excreted faeces per day across countries.\n\n\n\n::: {#cell-fig-total-excreted-perday .cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nexcreted_total %>% \n  merge(farms_geometry, by = \"farm_ID\") %>% \n  mutate(excr_biom_mean = excr_biom_mean %>% set_units(\"g gfish-1 d-1\") %>% set_units(\"g kgfish-1 d-1\"),\n         country = factor(country, levels = sorted_countries)) %>% \n  ggplot(aes(x = country, y = excr_biom_mean, fill = feed)) +\n  geom_boxplot() +\n  theme_classic() +\n  scale_fill_manual(values = feed_pal) +\n  labs(y = \"Excreted faeces\", x = \"Country\")\n```\n\n::: {.cell-output-display}\n![](manuscript_files/figure-html/fig-total-excreted-perday-1.png){#fig-total-excreted-perday fig-align='center' width=864}\n:::\n:::\n\n\n\n### Total amount\n\n\n\n::: {#cell-fig-total-excr-diff_perc .cell layout-align=\"center\"}\n:::: aside\n\n```{.r .cell-code .hidden}\ndf <- excreted_total %>% \n  select(-contains(c(\"sd\", \"biom\"))) %>% \n  pivot_wider(names_from = \"feed\", values_from = \"excr_mean\") %>% \n  mutate(past = past-reference,\n         future = future-reference) %>% \n  pivot_longer(names_to = \"feed\", values_to = \"diff\", cols = c(past, future), names_transform = list(feed = as.factor)) %>% \n  mutate(reference = set_units(reference, \"g kgfish-1 d-1\"),\n         diff_perc = drop_units(diff/reference)) %>% \n    merge(farm_coords, by = \"farm_ID\") %>% \n  mutate(prod_day = t - t_start + 1)\n\nsumm <- df %>%\n  group_by(hemisphere, feed) %>% \n  reframe(mean = 100*meanna(diff_perc) %>% round(3),\n          min = 100*meanna(diff_perc) %>% round(3),\n          max = 100*maxna(diff_perc) %>% round(3))\n\ndf %>% \n  ggplot(aes(x = reference, y = diff_perc, colour = hemisphere)) +\n  geom_point() + \n  geom_hline(yintercept = 0, linetype = \"dashed\") +\n  facet_grid(~feed) +\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![Mean % difference in excreted faeces of the two experimental feeds (compared to the reference feed) with increasing overall excretion.](manuscript_files/figure-html/fig-total-excr-diff_perc-1.png){#fig-total-excr-diff_perc fig-align='center' width=816}\n:::\n::::\n:::\n\n\n\nThere was very little variation in the percentage difference (from reference) excreted with increasing overall excretion (@fig-total-excr-diff_perc), or through time (@fig-total-excr-diff_perc_2). \nThe difference in total excretion for the past feed ranged from \n-26, -26.1--23.9, -23.9% across all farms globally, and for the future feed ranged from \n1.3, 1.3-4.1, 3.7%. \n\n\n\n::: {#cell-fig-total-excr-diff_perc_2 .cell layout-align=\"center\"}\n:::: aside\n\n```{.r .cell-code .hidden}\ndf %>% \n  group_by(prod_day, feed, hemisphere) %>% \n  reframe(diff_perc_mean = meanna(diff_perc),\n          diff_perc_sd = sdna(diff_perc)) %>% \n  ggplot(aes(x = prod_day, y = diff_perc_mean, ymin = diff_perc_mean-diff_perc_sd, ymax = diff_perc_mean+diff_perc_sd, \n             colour = as.factor(hemisphere), fill = as.factor(hemisphere))) +\n  geom_line() + \n  geom_ribbon(alpha = 0.25) +\n  geom_hline(yintercept = 0, linetype = \"dashed\") +\n  facet_grid(~feed) +\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![Mean % difference in excreted faeces of the two experimental feeds (compared to the reference feed) over time in one production cycle.](manuscript_files/figure-html/fig-total-excr-diff_perc_2-1.png){#fig-total-excr-diff_perc_2 fig-align='center' width=816}\n:::\n::::\n:::\n\n\n\nHowever, the actual difference in excreted faeces varied by feed, time in the production cycle, and location of the farm [@fig-total-excr-act_diff].\n\n\n\n::: {#cell-fig-total-excr-act_diff .cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\ndf <- excr_total %>% \n  select(-c(sd, sd_pc)) %>% \n  pivot_wider(names_from = \"feed\", values_from = \"mean\") %>% \n  mutate(past = past-reference,\n         future = future-reference) %>% \n  pivot_longer(names_to = \"feed\", values_to = \"diff\", cols = c(past, future), names_transform = list(feed = as.factor)) %>% \n  mutate(reference = set_units(reference, \"g kgfish-1 d-1\"),\n         diff = set_units(diff, \"kg tfish-1 d-1\")) \n\nsumm <- df %>%\n  group_by(hemisphere, feed) %>% \n  reframe(mean = meanna(diff) %>% round(3),\n          min = meanna(diff) %>% round(3),\n          max = maxna(diff) %>% round(3))\n\ndf %>% \n  group_by(hemisphere, feed, prod_day) %>% \n  reframe(mean_diff = meanna(diff),\n          sd_diff = sdna(diff) %>% set_units(\"kg tfish-1 d-1\")) %>% \n  ggplot(aes(x = prod_day, y = mean_diff, ymin = mean_diff-sd_diff, ymax = mean_diff+sd_diff, colour = hemisphere, fill = hemisphere)) +\n  geom_line(linewidth = 0.75) +\n  geom_ribbon(alpha = 0.25) +\n  facet_wrap(~feed) +\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![Mean actual difference in excreted faeces of the two experimental feeds (compared to the reference feed) over time in one production cycle.](manuscript_files/figure-html/fig-total-excr-act_diff-1.png){#fig-total-excr-act_diff fig-align='center' width=600}\n:::\n:::\n\n\n\n### Excreted composition\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nexcreted_P <- farmrun_files %>% purrr::map(function(f) {qs::qread(f)[[\"P_excr_stat\"]]}) %>% bind_rows()\nexcreted_L <- farmrun_files %>% purrr::map(function(f) {qs::qread(f)[[\"L_excr_stat\"]]}) %>% bind_rows()\nexcreted_C <- farmrun_files %>% purrr::map(function(f) {qs::qread(f)[[\"C_excr_stat\"]]}) %>% bind_rows()\n\nexcreted_all <- excreted_total %>% \n  select(-contains(\"biom\")) %>% \n  merge(excreted_P, by = c(\"farm_ID\", \"feed\", \"t\")) %>% \n  merge(excreted_L, by = c(\"farm_ID\", \"feed\", \"t\")) %>% \n  merge(excreted_C, by = c(\"farm_ID\", \"feed\", \"t\")) %>% \n  select(-c(contains(\"sd\"))) %>% \n  rename(protein = mean.x, lipids = mean.y, carbohydrates = mean) %>% \n  mutate(protein = protein/excr_mean %>% set_units(\"d-1\"),\n         lipids = lipids/excr_mean %>% set_units(\"d-1\"),\n         carbohydrates = carbohydrates/excr_mean %>% set_units(\"d-1\")) %>% \n  select(-excr_mean)\n```\n:::\n\n\n\nUnlike the uneaten feed, the composition of excreted faeces differs from that of the incoming feed.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nexcreted_all %>% \n  pivot_longer(names_to = \"macro\", values_to = \"perc\", cols = c(\"protein\", \"lipids\", \"carbohydrates\")) %>% \n  mutate(macro = factor(macro, levels = c(\"protein\", \"lipids\", \"carbohydrates\"))) %>% \n  group_by(farm_ID, feed, macro) %>% \n  reframe(sd = sd(perc) %>% set_units(\"d-1\"),\n          mean = mean(perc)) %>% \n  ggplot(aes(x = farm_ID, colour = feed, fill = feed, y = 100*mean, ymin = 100*(mean-sd), ymax = 100*(mean+sd))) +\n  geom_point(size = 2) +\n  geom_errorbar(width = 0.5) +\n  scale_color_manual(values = feed_pal) +\n  scale_fill_manual(values = feed_pal) +\n  facet_grid(rows = vars(macro)) +\n  theme_classic() +\n  labs(x = \"Macronutrient\", y = \"Mean composition of faeces\")\n```\n\n::: {.cell-output-display}\n![](manuscript_files/figure-html/composition-throughtime-1.png){fig-align='center' width=816}\n:::\n:::\n\n\n\n\n\n\n## Total nutrients (amount & source)\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .hidden}\nworldmap <- ne_countries(scale = \"large\", returnclass = \"sf\")\n\nAUS_bounds <- c(144, 149.5, -39.75, -44)\nCAN1_bounds <- c(-132, -122, 47.75, 54.25)\nCAN2_bounds <- c(-70, -54, 43, 48.5)\nCHI_bounds <- c(-77.5, -62.5, -56, -25)\nEUR_bounds <- c(-26, 30, 51, 71)\n\np_ALL <- ggplot(data = worldmap, aes(geometry = geometry)) +\n  geom_sf(fill = \"white\", color = \"dimgray\") +\n  geom_sf(data = farm_temp_means, aes(colour = mean_temp), size = 1.5) +\n  coord_sf() +\n  theme_classic()\n\nno_margins <- function() {\n  theme(legend.position = \"none\", \n        plot.margin = margin(),\n        axis.title = element_blank())\n}\n\np_Aus <- p_ALL + coord_sf(xlim = AUS_bounds[1:2], ylim = AUS_bounds[3:4], expand = FALSE) + no_margins()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nCoordinate system already present. Adding new coordinate system, which will\nreplace the existing one.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\np_Eur <- p_ALL + coord_sf(xlim = EUR_bounds[1:2], ylim = EUR_bounds[3:4], expand = FALSE) + no_margins()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nCoordinate system already present. Adding new coordinate system, which will\nreplace the existing one.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\np_Chi <- p_ALL + coord_sf(xlim = CHI_bounds[1:2], ylim = CHI_bounds[3:4], expand = FALSE) + no_margins()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nCoordinate system already present. Adding new coordinate system, which will\nreplace the existing one.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\np_Can <- p_ALL + coord_sf(xlim = CAN1_bounds[1:2], ylim = CAN1_bounds[3:4], expand = FALSE) + no_margins()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nCoordinate system already present. Adding new coordinate system, which will\nreplace the existing one.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\np_USA <- p_ALL + coord_sf(xlim = CAN2_bounds[1:2], ylim = CAN2_bounds[3:4], expand = FALSE) + no_margins()\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nCoordinate system already present. Adding new coordinate system, which will\nreplace the existing one.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nsubplot <- (p_Eur/p_Aus) + plot_layout(heights = c(1.5, 1))\nfinalplot <- (p_Can + p_USA) / (p_Chi + subplot) + \n  plot_layout(widths = c(1, 1.5), heights = c(1, 2)) &\n  theme(plot.margin = margin(0, 0, 0, 0))\nfinalplot\n```\n\n::: {.cell-output-display}\n![](manuscript_files/figure-html/patchwork map-1.png){fig-align='center' width=816}\n:::\n:::\n\n\n\n\n# Statistical analysis & code availability\n\nAll analysis was conducted in R version 4.4.2 \"Pile of Leaves\" [@R_base]. \nMajor packages used include terra [@terra], targets [@targets], future [@future], furrr [@furrr], and the tidyverse [@tidyverse].\nFor a full list of R packages used see the lockfile on [Github](https://www.github.com).\nThis manuscript was written in Quarto [@quarto] using TinyTex [@tinytex] and the acronyms extension [@acronyms]. \n\n# References\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}