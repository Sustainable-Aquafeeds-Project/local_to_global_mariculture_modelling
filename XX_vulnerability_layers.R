library(tidyr)
library(dplyr)
library(magrittr)
library(stringr)
library(here)
library(terra)
library(sf)
library(qs)
library(countrycode)
library(terra)
library(furrr)
library(rnaturalearth)

source("00_dirs.R")

# Global areas ----------------------------------------------------------------------------------------------------
base_rast <- rast(res = 0.5)
values(base_rast) <- 1:ncell(base_rast)


gall_rast <- rast(ext(-20037508, 20037508, -10000000, 10000000), 
                  resolution = 10000, 
                  crs = "ESRI:54016")

values(gall_rast) <- 1:ncell(gall_rast)

#bounding boxes
east_canada_bbox <- c(xmin = -75, xmax = -45, ymin = 39, ymax = 54)
west_canada_bbox <- c(xmin =-140, xmax = -115, ymin = 45, ymax = 57)
chile_bbox <- c(xmin = -82, xmax = -63, ymin = -57, ymax = -18)
europe_iceland_bbox <- c(xmin = -29, xmax = 48, ymin = 46, ymax = 73)
australia_bbox <- c(xmin = 143, xmax = 149, ymin = -44, ymax = -40)


# Get and filter data ---------------------------------------------------------------------------------------------
full_vuln_df <- here() %>% 
  file.path(input_spec_layers_path, "marine_spp_vulnerabilities_eutrophication.qs") %>% 
  qread() 

# Background nitrogen ---------------------------------------------------------------------------------------------
# Data is downloaded from here: https://doi.org/10.5063/F1610XPS
back_N_rast <- here() %>% 
  file.path("data", "_general_data", "background_nitrogen", "nutrient_pollution_2013_raw.tif") %>% 
  rast()

# Farm locations --------------------------------------------------------------------------------------------------
farm_locs <- here() %>% 
  file.path(input_farm_coords_path, "atlantic_salmon_locations_w_temps.qs") %>% 
  qread() %>% 
  pull(geometry) 

# Create circular buffers and merge overlapping ones
farm_circles <- st_sf(loc_id = 1:length(farm_locs), geometry = farm_locs) %>%
  st_transform(crs = crs(back_N_rast)) %>%  # transform to match background N projection
  st_buffer(dist = 1000) %>%  # 1km radius circles
  st_union() %>%  # merge overlapping polygons
  st_sf() %>%  # convert back to sf object
  mutate(id = 1)  # add single ID for rasterization

farm_rast <- rasterize(vect(farm_circles), back_N_rast, field = "id")



