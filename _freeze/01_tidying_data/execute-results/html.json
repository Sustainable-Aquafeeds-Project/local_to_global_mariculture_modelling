{
  "hash": "85fb7f0dc189c192ecdef86a584488b6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Tidying data\"\nauthor: Richard Cottrell\ndate: today\neditor: source\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(terra)\nlibrary(qs)\nlibrary(magrittr)\n\nsource(\"00_dirs.R\")\nsource(\"00_model_functions.R\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Specify species of interest\nspecies <- c(\"atlantic_salmon\", \"general_salmonid\")\n\nhere(\"src/spatial_templates.R\") %>% source()\n```\n:::\n\n\n\n# Mariculture locations\n\nPull in mariculture locations data from Clawson et al (2022) and save the species groups of interest.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfarm_locations <- file.path(rdsi_dir, \"raw_data/aquaculture-locations/all_marine_aquaculture_farms_sources_final.csv\") %>% \n  read.csv() %>% \n  filter(species_group %in% c(\"Salmonidae fish\", \"General marine fish\"))\n\nqsave(farm_locations, \"data/_general_data/farm_locations/locations.qs\")\n```\n:::\n\n\n\nDaily SST data from NASA - GHRSST Level 4 MUR 0.25deg Global Foundation Sea Surface Temperature Analysis\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnasa_dir <- \"/mnt/rdsi/raw_data/NASA/GHRSST_L4_MUR_0.25_SST/\"\n\n#rename the NASA files \n#SST_files <- list.files(file.path(rdsi_dir, \"raw_data/NASA/GHRSST_L4_MUR_0.25_SST\"), full.names = FALSE, pattern = \".nc\")\n# map(SST_files, \\(this_file){\n#   file.rename(from = file.path(nasa_dir, this_file), to = file.path(nasa_dir, sub('^(.{4})(.*)$', '\\\\1_\\\\2',  this_file)))\n# })\n\nSST_files <- list.files(file.path(rdsi_dir, \"raw_data/NASA/GHRSST_L4_MUR_0.25_SST\"), full.names = TRUE, pattern = \".nc\")\n\n# this_file <- SST_files[[1]]\n# this_year=2013\n\n#initialise lists for each year\nyears <- c(2010:2019)\nyear_lists <- vector(mode =\"list\", length = length(years))\n\n# Add annual files to a list of files for each year\nfor(y in 1:length(years)){\n  this_year <- years[y]\n  this_years_files <- SST_files[grep(paste0(this_year, \"_\"), SST_files)]\n  this_years_files <- this_years_files[!grepl(paste0(this_year, \"_0229\"), this_years_files)]\n  year_lists[[y]] <- this_years_files\n}\n  \n# Extract the daily files for each year and rasterize in a stack\ndays <- c(1:365)\nthis_day <- days[1]\nrast_list = vector(mode = \"list\", length = length(days))\n\nmap(days, \\(this_day){\n  this_days_file_list <- sapply(year_lists, \"[[\", this_day)\n  message(\"SST layer for Day \", this_day)\n  this_day_stack <- rast(this_days_file_list, subds = \"analysed_sst\")\n  this_day_mean_rast <- app(this_day_stack, \"mean\", na.rm=TRUE)-273.15\n  writeRaster(this_day_mean_rast, filename = sprintf(here(\"data/_general_data/SST/SST_rasters/sst_nasa_mur_L4_0.25_mean2010-2019_day_%s.tif\"), this_day))\n})\n  \n# now gapfill the saved rasters\nraw_SST_files <- list.files(\"data/_general_data/SST/SST_rasters/\", full.names = TRUE)\n\n#test function\n#this_file <- raw_SST_files[[1]]\n\nmap(.x = raw_SST_files, .f = \\(this_file){\n  saveName <-  basename(this_file)\n  message(\"Gapfilling \", saveName)\n  this_rast <- rast(this_file)\n  this_gf_rast <- focal(this_rast, w=7, fun = \"mean\", na.policy = \"only\")\n  writeRaster(this_gf_rast, filename = sprintf(\"data/_general_data/SST/SST_gf_rasters/%s\", saveName))\n})\n```\n:::\n\n\n\nPull in spp vulnerability to eutrophication data - save to salmon folder\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvuln_scores <- read.csv(file.path(rdsi_data_dir, \"marine_spp_vulnerabilities/butt_spp_vuln_framework-publication/_output/vuln_gapfilled_score.csv\")) %>% \n  select(vuln_gf_id, eutrophication_nutrient_pollution)\n\nvuln_sd <- read.csv(file.path(rdsi_data_dir, \"marine_spp_vulnerabilities/butt_spp_vuln_framework-publication/_output/vuln_gapfilled_sd.csv\")) %>% \n  select(vuln_gf_id, eutrophication_nutrient_pollution) %>% rename(sd=eutrophication_nutrient_pollution)\n\nvuln_tx <- read.csv(file.path(rdsi_data_dir, \"marine_spp_vulnerabilities/butt_spp_vuln_framework-publication/_output/vuln_gapfilled_tx.csv\"))\n\nfull_vuln_df <- \n  vuln_scores %>% \n  left_join(vuln_sd) %>% \n  left_join(vuln_tx)\n\nqsave(x = full_vuln_df, file = here(\"data/_general_data/species_layers/vulnerabilities/marine_spp_vulnerabilities_eutrophication.qs\"))\n```\n:::\n\n\n\nPull in spp distribution data from Aquamaps\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\naquamaps_0.5d <- data.table::fread(file.path(rdsi_data_dir, \"aquamaps/aquamaps_0.6_depth_prepped.csv\")) \n\n#all cells have an id. These id's can be used to isolate only the cells of relevance for the salmon farming locations.\nfilter(aquamaps_0.5d, is.na(cell_id))\n\n#save to project\nqsave(x = aquamaps_0.5d, file = here(\"data/_general_data/species_layers/distribution/aquamaps_0.5d.qs\"))\n```\n:::\n",
    "supporting": [
      "01_tidying_data_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}